---
id: intro5
permalink: /cdp/p5
title: 'Runtime'
---


# Runtime
```python
        
import json
import websocket
import requests
import time
import threading
from datetime import datetime

def get_websocket_url(port=9222):
    """è·å– WebSocket è°ƒè¯• URL"""
    response = requests.get(f'http://localhost:{port}/json')
    tabs = response.json()
    return tabs[0]['webSocketDebuggerUrl']

class CDPRuntime:
    """CDP Runtime å°è£…ç±»"""
    
    def __init__(self, ws_url):
        self.ws = websocket.create_connection(ws_url)
        self.command_id = 0
        self.event_handlers = {}
        self.running = True
        self.events_log = []
        
        # å¯åŠ¨äº‹ä»¶ç›‘å¬çº¿ç¨‹
        self.event_thread = threading.Thread(target=self._event_listener, daemon=True)
        self.event_thread.start()
        
    def send_command(self, method, params=None):
        """å‘é€ CDP å‘½ä»¤"""
        self.command_id += 1
        command = {
            "id": self.command_id,
            "method": method,
            "params": params or {}
        }
        print(f"\n>>> å‘é€å‘½ä»¤: {method}")
        if params:
            params_str = json.dumps(params, indent=6, ensure_ascii=False)
            if len(params_str) > 500:
                params_str = params_str[:500] + "..."
            print(f"    å‚æ•°: {params_str}")
        
        self.ws.send(json.dumps(command))
        
        # ç­‰å¾…å“åº”
        start_time = time.time()
        while time.time() - start_time < 10:  # 10ç§’è¶…æ—¶
            try:
                response = json.loads(self.ws.recv())
                if 'id' in response and response['id'] == self.command_id:
                    if 'error' not in response:
                        print(f"<<< å“åº”æˆåŠŸ")
                        if 'result' in response:
                            result_str = json.dumps(response['result'], indent=6, ensure_ascii=False)
                            if len(result_str) > 500:
                                result_str = result_str[:500] + "..."
                            print(f"    ç»“æœ: {result_str}")
                    else:
                        print(f"<<< é”™è¯¯: {response['error']}")
                    return response
                elif 'method' in response:
                    self._handle_event(response)
            except Exception as e:
                continue
        
        print(f"<<< è¶…æ—¶")
        return {"error": "timeout"}
    
    def _event_listener(self):
        """åå°ç›‘å¬äº‹ä»¶"""
        while self.running:
            try:
                self.ws.settimeout(0.1)
                message = self.ws.recv()
                data = json.loads(message)
                if 'method' in data:
                    self._handle_event(data)
            except:
                continue
    
    def _handle_event(self, event):
        """å¤„ç†äº‹ä»¶"""
        method = event['method']
        self.events_log.append({
            'timestamp': datetime.now().isoformat(),
            'method': method,
            'params': event.get('params', {})
        })
        
        if method in self.event_handlers:
            self.event_handlers[method](event)
    
    def on_event(self, event_name, handler):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        self.event_handlers[event_name] = handler
    
    def close(self):
        self.running = False
        time.sleep(0.2)
        self.ws.close()


# ========================================
# ç¤ºä¾‹ 1: åŸºç¡€ JavaScript æ‰§è¡Œ
# ========================================
def example_basic_evaluation():
    """
    æ¼”ç¤ºåŸºç¡€ JavaScript æ‰§è¡Œ:
    1. Runtime.enable - å¯ç”¨è¿è¡Œæ—¶
    2. Runtime.evaluate - æ‰§è¡Œè¡¨è¾¾å¼
    3. ä¸åŒçš„è¿”å›å€¼ç±»å‹
    4. returnByValue vs objectId
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 1: åŸºç¡€ JavaScript æ‰§è¡Œ")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    
    # 1. å¯ç”¨ Runtime
    print("\n--- å¯ç”¨ Runtime ---")
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    runtime.send_command("Page.navigate", {"url": "https://example.com"})
    time.sleep(2)
    
    # 2. æ‰§è¡Œç®€å•è¡¨è¾¾å¼
    print("\n--- æ‰§è¡Œç®€å•è¡¨è¾¾å¼ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": "1 + 1",
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        value = result['result']['result']['value']
        print(f"    è®¡ç®—ç»“æœ: {value}")
    
    # 3. è·å–é¡µé¢ä¿¡æ¯
    print("\n--- è·å–é¡µé¢ä¿¡æ¯ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": "document.title",
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        title = result['result']['result']['value']
        print(f"    é¡µé¢æ ‡é¢˜: {title}")
    
    # 4. æ‰§è¡Œå¤æ‚å¯¹è±¡å¹¶è¿”å›å€¼
    print("\n--- è¿”å›å¯¹è±¡ (returnByValue) ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            ({
                url: window.location.href,
                width: window.innerWidth,
                height: window.innerHeight,
                userAgent: navigator.userAgent.substring(0, 50)
            })
        """,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        obj = result['result']['result']['value']
        print(f"    è¿”å›å¯¹è±¡: {json.dumps(obj, indent=8, ensure_ascii=False)}")
    
    # 5. è·å–å¯¹è±¡å¼•ç”¨ (objectId)
    print("\n--- è·å–å¯¹è±¡å¼•ç”¨ (objectId) ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": "document.body",
        "returnByValue": False  # è¿”å›å¯¹è±¡å¼•ç”¨
    })
    
    if 'result' in result and 'result' in result['result']:
        object_id = result['result']['result'].get('objectId')
        if object_id:
            print(f"    å¯¹è±¡ ID: {object_id[:50]}...")
            print(f"    ç±»å‹: {result['result']['result'].get('type')}")
            print(f"    å­ç±»å‹: {result['result']['result'].get('subtype')}")
    
    # 6. æ‰§è¡Œå¼‚æ­¥ä»£ç 
    print("\n--- æ‰§è¡Œå¼‚æ­¥ä»£ç  (Promise) ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            new Promise((resolve) => {
                setTimeout(() => {
                    resolve('å¼‚æ­¥ç»“æœ: å»¶è¿Ÿ1ç§’');
                }, 1000);
            })
        """,
        "awaitPromise": True,  # ç­‰å¾… Promise å®Œæˆ
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        value = result['result']['result']['value']
        print(f"    å¼‚æ­¥ç»“æœ: {value}")
    
    runtime.close()


# ========================================
# ç¤ºä¾‹ 2: å¯¹è±¡å±æ€§æ£€æŸ¥
# ========================================
def example_object_inspection():
    """
    æ¼”ç¤ºå¯¹è±¡æ£€æŸ¥:
    1. Runtime.getProperties - è·å–å¯¹è±¡å±æ€§
    2. Runtime.callFunctionOn - åœ¨å¯¹è±¡ä¸Šè°ƒç”¨å‡½æ•°
    3. Runtime.releaseObject - é‡Šæ”¾å¯¹è±¡
    4. Runtime.releaseObjectGroup - é‡Šæ”¾å¯¹è±¡ç»„
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 2: å¯¹è±¡å±æ€§æ£€æŸ¥")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    runtime.send_command("Page.navigate", {"url": "https://example.com"})
    time.sleep(2)
    
    # 1. è·å– window å¯¹è±¡
    print("\n--- è·å– window å¯¹è±¡å¼•ç”¨ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": "window",
        "returnByValue": False
    })
    
    window_object_id = None
    if 'result' in result and 'result' in result['result']:
        window_object_id = result['result']['result'].get('objectId')
        print(f"    Window å¯¹è±¡ ID: {window_object_id[:50]}...")
    
    # 2. è·å– window å¯¹è±¡çš„å±æ€§
    if window_object_id:
        print("\n--- è·å– window å¯¹è±¡çš„å±æ€§ ---")
        props = runtime.send_command("Runtime.getProperties", {
            "objectId": window_object_id,
            "ownProperties": True,  # åªè·å–è‡ªæœ‰å±æ€§
            "accessorPropertiesOnly": False,
            "generatePreview": True
        })
        
        if 'result' in props and 'result' in props['result']:
            properties = props['result']['result']
            print(f"    å±æ€§æ•°é‡: {len(properties)}")
            print(f"\n    å‰10ä¸ªå±æ€§:")
            for i, prop in enumerate(properties[:10], 1):
                name = prop.get('name', 'N/A')
                value = prop.get('value', {})
                prop_type = value.get('type', 'N/A')
                print(f"      {i}. {name}: {prop_type}")
    
    # 3. è·å– document å¯¹è±¡å¹¶æ£€æŸ¥
    print("\n--- æ£€æŸ¥ document å¯¹è±¡ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": "document",
        "returnByValue": False
    })
    
    doc_object_id = None
    if 'result' in result and 'result' in result['result']:
        doc_object_id = result['result']['result'].get('objectId')
    
    if doc_object_id:
        props = runtime.send_command("Runtime.getProperties", {
            "objectId": doc_object_id,
            "ownProperties": False  # åŒ…æ‹¬åŸå‹é“¾
        })
        
        if 'result' in props and 'result' in props['result']:
            # æŸ¥æ‰¾ç‰¹å®šå±æ€§
            properties = props['result']['result']
            interesting_props = ['title', 'URL', 'domain', 'readyState']
            
            print(f"    æ–‡æ¡£å±æ€§:")
            for prop in properties:
                if prop.get('name') in interesting_props:
                    name = prop['name']
                    value = prop.get('value', {})
                    if 'value' in value:
                        print(f"      {name}: {value['value']}")
    
    # 4. åœ¨å¯¹è±¡ä¸Šè°ƒç”¨å‡½æ•°
    if doc_object_id:
        print("\n--- åœ¨ document ä¸Šè°ƒç”¨å‡½æ•° ---")
        result = runtime.send_command("Runtime.callFunctionOn", {
            "objectId": doc_object_id,
            "functionDeclaration": """
                function() {
                    return {
                        elementCount: this.getElementsByTagName('*').length,
                        linkCount: this.getElementsByTagName('a').length,
                        imageCount: this.getElementsByTagName('img').length
                    };
                }
            """,
            "returnByValue": True
        })
        
        if 'result' in result and 'result' in result['result']:
            stats = result['result']['result']['value']
            print(f"    é¡µé¢ç»Ÿè®¡: {json.dumps(stats, indent=8)}")
    
    # 5. é‡Šæ”¾å¯¹è±¡
    print("\n--- é‡Šæ”¾å¯¹è±¡å¼•ç”¨ ---")
    if window_object_id:
        runtime.send_command("Runtime.releaseObject", {
            "objectId": window_object_id
        })
        print(f"    å·²é‡Šæ”¾ window å¯¹è±¡")
    
    if doc_object_id:
        runtime.send_command("Runtime.releaseObject", {
            "objectId": doc_object_id
        })
        print(f"    å·²é‡Šæ”¾ document å¯¹è±¡")
    
    runtime.close()


# ========================================
# ç¤ºä¾‹ 3: æ§åˆ¶å°æ¶ˆæ¯å¤„ç†
# ========================================
def example_console_handling():
    """
    æ¼”ç¤ºæ§åˆ¶å°æ¶ˆæ¯å¤„ç†:
    1. Runtime.consoleAPICalled - æ§åˆ¶å° API è°ƒç”¨
    2. Runtime.exceptionThrown - å¼‚å¸¸æŠ›å‡º
    3. ä¸åŒç±»å‹çš„æ§åˆ¶å°æ¶ˆæ¯
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 3: æ§åˆ¶å°æ¶ˆæ¯å¤„ç†")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    
    console_messages = []
    exceptions = []
    
    def handle_console_api(event):
        params = event['params']
        msg_type = params.get('type', 'log')
        args = params.get('args', [])
        
        # æå–å‚æ•°å€¼
        values = []
        for arg in args:
            if 'value' in arg:
                values.append(str(arg['value']))
            elif 'description' in arg:
                values.append(arg['description'])
            else:
                values.append(str(arg.get('type', 'unknown')))
        
        message = ' '.join(values)
        console_messages.append({
            'type': msg_type,
            'message': message,
            'timestamp': params.get('timestamp')
        })
        
        icon = {
            'log': 'ğŸ“',
            'info': 'â„¹ï¸',
            'warn': 'âš ï¸',
            'error': 'âŒ',
            'debug': 'ğŸ›'
        }.get(msg_type, 'ğŸ“')
        
        print(f"\n{icon} æ§åˆ¶å° [{msg_type}]: {message}")
    
    def handle_exception(event):
        params = event['params']
        exception_details = params.get('exceptionDetails', {})
        
        text = exception_details.get('text', 'N/A')
        exception = exception_details.get('exception', {})
        description = exception.get('description', '')
        
        exceptions.append({
            'text': text,
            'description': description,
            'timestamp': params.get('timestamp')
        })
        
        print(f"\nğŸ’¥ JavaScript å¼‚å¸¸:")
        print(f"    é”™è¯¯: {text}")
        if description:
            print(f"    æè¿°: {description[:200]}")
    
    runtime.on_event("Runtime.consoleAPICalled", handle_console_api)
    runtime.on_event("Runtime.exceptionThrown", handle_exception)
    
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    runtime.send_command("Page.navigate", {"url": "https://example.com"})
    time.sleep(2)
    
    # 1. è§¦å‘ä¸åŒç±»å‹çš„æ§åˆ¶å°æ¶ˆæ¯
    print("\n--- è§¦å‘æ§åˆ¶å°æ¶ˆæ¯ ---")
    
    runtime.send_command("Runtime.evaluate", {
        "expression": "console.log('è¿™æ˜¯ä¸€æ¡æ—¥å¿—æ¶ˆæ¯')"
    })
    
    runtime.send_command("Runtime.evaluate", {
        "expression": "console.info('è¿™æ˜¯ä¸€æ¡ä¿¡æ¯æ¶ˆæ¯')"
    })
    
    runtime.send_command("Runtime.evaluate", {
        "expression": "console.warn('è¿™æ˜¯ä¸€æ¡è­¦å‘Šæ¶ˆæ¯')"
    })
    
    runtime.send_command("Runtime.evaluate", {
        "expression": "console.error('è¿™æ˜¯ä¸€æ¡é”™è¯¯æ¶ˆæ¯')"
    })
    
    # 2. è¾“å‡ºå¯¹è±¡
    print("\n--- è¾“å‡ºå¯¹è±¡ ---")
    runtime.send_command("Runtime.evaluate", {
        "expression": """
            console.log('ç”¨æˆ·ä¿¡æ¯:', {
                name: 'Alice',
                age: 30,
                role: 'Developer'
            })
        """
    })
    
    # 3. è§¦å‘å¼‚å¸¸
    print("\n--- è§¦å‘å¼‚å¸¸ ---")
    runtime.send_command("Runtime.evaluate", {
        "expression": "throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯')"
    })
    
    runtime.send_command("Runtime.evaluate", {
        "expression": "undefinedFunction()"  # å¼•ç”¨é”™è¯¯
    })
    
    time.sleep(2)
    
    # 4. æ˜¾ç¤ºç»Ÿè®¡
    print("\n" + "="*60)
    print(f"ğŸ“Š ç»Ÿè®¡:")
    print(f"    æ§åˆ¶å°æ¶ˆæ¯: {len(console_messages)} æ¡")
    print(f"    å¼‚å¸¸: {len(exceptions)} ä¸ª")
    
    if console_messages:
        print(f"\næ§åˆ¶å°æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ:")
        types_count = {}
        for msg in console_messages:
            t = msg['type']
            types_count[t] = types_count.get(t, 0) + 1
        for t, count in types_count.items():
            print(f"      {t}: {count}")
    print("="*60)
    
    runtime.close()


# ========================================
# ç¤ºä¾‹ 4: æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†
# ========================================
def example_execution_contexts():
    """
    æ¼”ç¤ºæ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†:
    1. Runtime.executionContextCreated - ä¸Šä¸‹æ–‡åˆ›å»º
    2. Runtime.executionContextDestroyed - ä¸Šä¸‹æ–‡é”€æ¯
    3. åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç 
    4. iframe ä¸Šä¸‹æ–‡
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 4: æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    
    contexts = {}
    
    def handle_context_created(event):
        context = event['params']['context']
        context_id = context['id']
        name = context.get('name', 'unnamed')
        origin = context.get('origin', 'N/A')
        
        contexts[context_id] = context
        
        print(f"\nğŸ†• æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»º:")
        print(f"    ID: {context_id}")
        print(f"    åç§°: {name}")
        print(f"    æ¥æº: {origin}")
        print(f"    æ˜¯å¦é»˜è®¤: {context.get('auxData', {}).get('isDefault', False)}")
    
    def handle_context_destroyed(event):
        context_id = event['params']['executionContextId']
        if context_id in contexts:
            del contexts[context_id]
        print(f"\nâŒ æ‰§è¡Œä¸Šä¸‹æ–‡é”€æ¯: {context_id}")
    
    runtime.on_event("Runtime.executionContextCreated", handle_context_created)
    runtime.on_event("Runtime.executionContextDestroyed", handle_context_destroyed)
    
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    
    # 1. å¯¼èˆªåˆ°æœ‰ iframe çš„é¡µé¢
    print("\n--- å¯¼èˆªåˆ°åŒ…å« iframe çš„é¡µé¢ ---")
    runtime.send_command("Page.navigate", {
        "url": "data:text/html,<html><body><h1>ä¸»é¡µé¢</h1><iframe src='data:text/html,<h1>iframe</h1>'></iframe></body></html>"
    })
    
    time.sleep(3)
    
    # 2. æ˜¾ç¤ºæ‰€æœ‰æ‰§è¡Œä¸Šä¸‹æ–‡
    print("\n--- å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ ---")
    print(f"    ä¸Šä¸‹æ–‡æ•°é‡: {len(contexts)}")
    for i, (ctx_id, ctx) in enumerate(contexts.items(), 1):
        print(f"\n  {i}. ä¸Šä¸‹æ–‡ ID: {ctx_id}")
        print(f"     åç§°: {ctx.get('name', 'N/A')}")
        print(f"     æ¥æº: {ctx.get('origin', 'N/A')}")
    
    # 3. åœ¨ä¸»ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç 
    print("\n--- åœ¨ä¸»ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ ---")
    main_context = None
    for ctx_id, ctx in contexts.items():
        if ctx.get('auxData', {}).get('isDefault'):
            main_context = ctx_id
            break
    
    if main_context:
        result = runtime.send_command("Runtime.evaluate", {
            "expression": "document.querySelector('h1').textContent",
            "contextId": main_context,
            "returnByValue": True
        })
        
        if 'result' in result and 'result' in result['result']:
            print(f"    ä¸»é¡µé¢ h1: {result['result']['result']['value']}")
    
    # 4. åœ¨æ‰€æœ‰ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
    print("\n--- åœ¨æ‰€æœ‰ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ ---")
    for ctx_id in contexts.keys():
        result = runtime.send_command("Runtime.evaluate", {
            "expression": "window.location.href",
            "contextId": ctx_id,
            "returnByValue": True
        })
        
        if 'result' in result and 'result' in result['result']:
            url = result['result']['result']['value']
            print(f"    ä¸Šä¸‹æ–‡ {ctx_id}: {url[:80]}")
    
    runtime.close()


# ========================================
# ç¤ºä¾‹ 5: é«˜çº§ JavaScript æ“ä½œ
# ========================================
def example_advanced_operations():
    """
    æ¼”ç¤ºé«˜çº§æ“ä½œ:
    1. Runtime.compileScript - ç¼–è¯‘è„šæœ¬
    2. Runtime.runScript - è¿è¡Œè„šæœ¬
    3. Runtime.globalLexicalScopeNames - å…¨å±€è¯æ³•ä½œç”¨åŸŸ
    4. æ€§èƒ½æµ‹é‡
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 5: é«˜çº§ JavaScript æ“ä½œ")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    runtime.send_command("Page.navigate", {"url": "https://example.com"})
    time.sleep(2)
    
    # 1. ç¼–è¯‘è„šæœ¬
    print("\n--- ç¼–è¯‘ JavaScript è„šæœ¬ ---")
    script_source = """
        function fibonacci(n) {
            if (n <= 1) return n;
            return fibonacci(n - 1) + fibonacci(n - 2);
        }
        
        fibonacci(10);
    """
    
    compile_result = runtime.send_command("Runtime.compileScript", {
        "expression": script_source,
        "sourceURL": "fibonacci.js",
        "persistScript": True
    })
    
    script_id = None
    if 'result' in compile_result and 'scriptId' in compile_result['result']:
        script_id = compile_result['result']['scriptId']
        print(f"    ç¼–è¯‘æˆåŠŸï¼Œè„šæœ¬ ID: {script_id}")
    
    # 2. è¿è¡Œç¼–è¯‘çš„è„šæœ¬
    if script_id:
        print("\n--- è¿è¡Œç¼–è¯‘çš„è„šæœ¬ ---")
        run_result = runtime.send_command("Runtime.runScript", {
            "scriptId": script_id,
            "returnByValue": True
        })
        
        if 'result' in run_result and 'result' in run_result['result']:
            result_value = run_result['result']['result']['value']
            print(f"    æ‰§è¡Œç»“æœ: fibonacci(10) = {result_value}")
    
    # 3. è·å–å…¨å±€è¯æ³•ä½œç”¨åŸŸåç§°
    print("\n--- è·å–å…¨å±€è¯æ³•ä½œç”¨åŸŸ ---")
    scope_result = runtime.send_command("Runtime.globalLexicalScopeNames")
    
    if 'result' in scope_result and 'names' in scope_result['result']:
        names = scope_result['result']['names']
        print(f"    å…¨å±€å˜é‡æ•°é‡: {len(names)}")
        if names:
            print(f"    å‰10ä¸ª: {names[:10]}")
    
    # 4. æ€§èƒ½æµ‹é‡
    print("\n--- æ€§èƒ½æµ‹é‡ç¤ºä¾‹ ---")
    
    # æµ‹è¯• eval æ€§èƒ½
    start_time = time.time()
    runtime.send_command("Runtime.evaluate", {
        "expression": "Array.from({length: 1000}, (_, i) => i).reduce((a, b) => a + b, 0)",
        "returnByValue": True
    })
    eval_time = time.time() - start_time
    print(f"    Runtime.evaluate è€—æ—¶: {eval_time:.3f}ç§’")
    
    # 5. æ‰§è¡Œå¤æ‚æ“ä½œ
    print("\n--- æ‰§è¡Œå¤æ‚ DOM æ“ä½œ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            (function() {
                const stats = {
                    totalElements: document.getElementsByTagName('*').length,
                    textNodes: 0,
                    maxDepth: 0
                };
                
                function getDepth(element, depth = 0) {
                    stats.maxDepth = Math.max(stats.maxDepth, depth);
                    for (let child of element.children) {
                        getDepth(child, depth + 1);
                    }
                }
                
                getDepth(document.body);
                
                // ç»Ÿè®¡æ–‡æœ¬èŠ‚ç‚¹
                const walker = document.createTreeWalker(
                    document.body,
                    NodeFilter.SHOW_TEXT
                );
                
                while (walker.nextNode()) {
                    if (walker.currentNode.textContent.trim()) {
                        stats.textNodes++;
                    }
                }
                
                return stats;
            })()
        """,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        stats = result['result']['result']['value']
        print(f"    DOM ç»Ÿè®¡: {json.dumps(stats, indent=8)}")
    
    runtime.close()


# ========================================
# ç¤ºä¾‹ 6: å¼‚æ­¥æ“ä½œå’Œ Promise
# ========================================
def example_async_operations():
    """
    æ¼”ç¤ºå¼‚æ­¥æ“ä½œ:
    1. awaitPromise - ç­‰å¾… Promise
    2. Promise é“¾å¼è°ƒç”¨
    3. async/await è¯­æ³•
    4. è¶…æ—¶å¤„ç†
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 6: å¼‚æ­¥æ“ä½œå’Œ Promise")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    runtime.send_command("Page.navigate", {"url": "https://httpbin.org/delay/1"})
    time.sleep(3)
    
    # 1. åŸºç¡€ Promise
    print("\n--- åŸºç¡€ Promise ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            new Promise((resolve) => {
                setTimeout(() => resolve('å»¶è¿Ÿ500ms'), 500);
            })
        """,
        "awaitPromise": True,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        print(f"    ç»“æœ: {result['result']['result']['value']}")
    
    # 2. Promise é“¾å¼è°ƒç”¨
    print("\n--- Promise é“¾å¼è°ƒç”¨ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            Promise.resolve(10)
                .then(x => x * 2)
                .then(x => x + 5)
                .then(x => `æœ€ç»ˆç»“æœ: ${x}`)
        """,
        "awaitPromise": True,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        print(f"    {result['result']['result']['value']}")
    
    # 3. async/await è¯­æ³•
    print("\n--- async/await è¯­æ³• ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            (async function() {
                await new Promise(r => setTimeout(r, 500));
                const data = {
                    timestamp: Date.now(),
                    message: 'Async æ“ä½œå®Œæˆ'
                };
                return data;
            })()
        """,
        "awaitPromise": True,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        data = result['result']['result']['value']
        print(f"    ç»“æœ: {json.dumps(data, indent=8)}")
    
    # 4. Fetch API (å¦‚æœé¡µé¢æ”¯æŒ)
    print("\n--- Fetch API ç¤ºä¾‹ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            fetch('https://httpbin.org/json')
                .then(response => response.json())
                .then(data => ({
                    hasData: data !== null,
                    keys: Object.keys(data).slice(0, 5)
                }))
                .catch(error => ({
                    error: error.message
                }))
        """,
        "awaitPromise": True,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        data = result['result']['result']['value']
        print(f"    Fetch ç»“æœ: {json.dumps(data, indent=8, ensure_ascii=False)}")
    
    # 5. Promise.all å¹¶è¡Œ
    print("\n--- Promise.all å¹¶è¡Œæ“ä½œ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            Promise.all([
                new Promise(r => setTimeout(() => r('ä»»åŠ¡1'), 300)),
                new Promise(r => setTimeout(() => r('ä»»åŠ¡2'), 200)),
                new Promise(r => setTimeout(() => r('ä»»åŠ¡3'), 100))
            ]).then(results => ({
                completed: results.length,
                results: results
            }))
        """,
        "awaitPromise": True,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        data = result['result']['result']['value']
        print(f"    å¹¶è¡Œç»“æœ: {json.dumps(data, indent=8, ensure_ascii=False)}")
    
    # 6. æ•è· Promise æ‹’ç»
    print("\n--- æ•è· Promise æ‹’ç» ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            new Promise((resolve, reject) => {
                setTimeout(() => reject(new Error('æ•…æ„æ‹’ç»')), 100);
            }).catch(error => ({
                caught: true,
                message: error.message
            }))
        """,
        "awaitPromise": True,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        data = result['result']['result']['value']
        print(f"    æ•è·ç»“æœ: {json.dumps(data, indent=8, ensure_ascii=False)}")
    
    runtime.close()


# ========================================
# ç¤ºä¾‹ 7: ç»¼åˆåº”ç”¨ - JavaScript è°ƒè¯•å·¥å…·
# ========================================
def example_debug_tool():
    """
    ç»¼åˆç¤ºä¾‹: å®ç° JavaScript è°ƒè¯•å·¥å…·
    1. å®æ—¶æ‰§è¡Œä»£ç 
    2. ç›‘æ§å¼‚å¸¸
    3. æŸ¥çœ‹å¯¹è±¡
    4. æ€§èƒ½åˆ†æ
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 7: JavaScript è°ƒè¯•å·¥å…·")
    print("="*60)
    
    runtime = CDPRuntime(get_websocket_url())
    
    # è°ƒè¯•å·¥å…·çŠ¶æ€
    debug_state = {
        "console_logs": [],
        "exceptions": [],
        "execution_count": 0,
        "object_cache": {}
    }
    
    def handle_console(event):
        params = event['params']
        msg_type = params.get('type', 'log')
        args = params.get('args', [])
        
        message_parts = []
        for arg in args:
            if 'value' in arg:
                message_parts.append(str(arg['value']))
            elif 'description' in arg:
                message_parts.append(arg['description'])
        
        message = ' '.join(message_parts)
        debug_state["console_logs"].append({
            'type': msg_type,
            'message': message
        })
        
        print(f"\n[CONSOLE] {msg_type.upper()}: {message}")
    
    def handle_exception(event):
        exception = event['params']['exceptionDetails']
        text = exception.get('text', 'Unknown error')
        
        debug_state["exceptions"].append({
            'text': text,
            'line': exception.get('lineNumber'),
            'column': exception.get('columnNumber')
        })
        
        print(f"\n[EXCEPTION] {text}")
        if exception.get('lineNumber'):
            print(f"    ä½ç½®: è¡Œ {exception['lineNumber']}, åˆ— {exception.get('columnNumber', 0)}")
    
    runtime.on_event("Runtime.consoleAPICalled", handle_console)
    runtime.on_event("Runtime.exceptionThrown", handle_exception)
    
    # å¯åŠ¨è°ƒè¯•ç¯å¢ƒ
    print("\n--- åˆå§‹åŒ–è°ƒè¯•ç¯å¢ƒ ---")
    runtime.send_command("Runtime.enable")
    runtime.send_command("Page.enable")
    runtime.send_command("Page.navigate", {"url": "https://example.com"})
    time.sleep(2)
    
    # 1. åˆ›å»ºè°ƒè¯•è¾…åŠ©å‡½æ•°
    print("\n--- æ³¨å…¥è°ƒè¯•è¾…åŠ©å‡½æ•° ---")
    runtime.send_command("Runtime.evaluate", {
        "expression": """
            window.__debug__ = {
                inspect: function(obj) {
                    console.log('=== Object Inspection ===');
                    console.log('Type:', typeof obj);
                    console.log('Constructor:', obj?.constructor?.name);
                    if (typeof obj === 'object' && obj !== null) {
                        console.log('Keys:', Object.keys(obj));
                    }
                    return obj;
                },
                
                measure: function(fn, label = 'Operation') {
                    const start = performance.now();
                    const result = fn();
                    const duration = performance.now() - start;
                    console.log(`${label} took ${duration.toFixed(2)}ms`);
                    return result;
                },
                
                memory: function() {
                    if (performance.memory) {
                        return {
                            used: (performance.memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB',
                            total: (performance.memory.totalJSHeapSize / 1048576).toFixed(2) + ' MB',
                            limit: (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2) + ' MB'
                        };
                    }
                    return null;
                }
            };
            
            console.log('Debug utilities loaded');
        """
    })
    
    time.sleep(1)
    
    # 2. æ‰§è¡Œè°ƒè¯•å‘½ä»¤
    print("\n--- æ‰§è¡Œè°ƒè¯•å‘½ä»¤ ---")
    
    # æ£€æŸ¥å†…å­˜
    print("\n  > æ£€æŸ¥å†…å­˜ä½¿ç”¨")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": "__debug__.memory()",
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        memory = result['result']['result']['value']
        if memory:
            print(f"    å†…å­˜ä½¿ç”¨: {json.dumps(memory, indent=8)}")
    
    # æ£€æŸ¥å¯¹è±¡
    print("\n  > æ£€æŸ¥ document å¯¹è±¡")
    runtime.send_command("Runtime.evaluate", {
        "expression": "__debug__.inspect(document)"
    })
    time.sleep(1)
    
    # æ€§èƒ½æµ‹é‡
    print("\n  > æ€§èƒ½æµ‹é‡")
    runtime.send_command("Runtime.evaluate", {
        "expression": """
            __debug__.measure(() => {
                let sum = 0;
                for (let i = 0; i < 1000000; i++) {
                    sum += i;
                }
                return sum;
            }, 'Sum calculation')
        """
    })
    time.sleep(1)
    
    # 3. æŸ¥è¯¢é¡µé¢ä¿¡æ¯
    print("\n--- æŸ¥è¯¢é¡µé¢ä¿¡æ¯ ---")
    queries = [
        ("æ ‡é¢˜", "document.title"),
        ("URL", "window.location.href"),
        ("å…ƒç´ æ•°é‡", "document.getElementsByTagName('*').length"),
        ("Cookie æ•°é‡", "document.cookie.split(';').length"),
        ("è§†å£å®½åº¦", "window.innerWidth"),
        ("è§†å£é«˜åº¦", "window.innerHeight")
    ]
    
    print("\n  é¡µé¢ä¿¡æ¯:")
    for label, expression in queries:
        result = runtime.send_command("Runtime.evaluate", {
            "expression": expression,
            "returnByValue": True
        })
        
        if 'result' in result and 'result' in result['result']:
            value = result['result']['result']['value']
            if isinstance(value, str) and len(value) > 80:
                value = value[:80] + "..."
            print(f"    {label}: {value}")
        
        debug_state["execution_count"] += 1
    
    # 4. æµ‹è¯•å¼‚å¸¸å¤„ç†
    print("\n--- æµ‹è¯•å¼‚å¸¸å¤„ç† ---")
    runtime.send_command("Runtime.evaluate", {
        "expression": "throw new Error('æµ‹è¯•å¼‚å¸¸æ•è·')"
    })
    time.sleep(1)
    
    # 5. æ‰§è¡Œå¤æ‚åˆ†æ
    print("\n--- æ‰§è¡Œé¡µé¢åˆ†æ ---")
    result = runtime.send_command("Runtime.evaluate", {
        "expression": """
            (function analyzeDOM() {
                const analysis = {
                    structure: {
                        depth: 0,
                        totalNodes: 0,
                        elementTypes: {}
                    },
                    content: {
                        totalText: 0,
                        links: 0,
                        images: 0,
                        forms: 0
                    },
                    scripts: {
                        inline: document.querySelectorAll('script:not([src])').length,
                        external: document.querySelectorAll('script[src]').length
                    },
                    styles: {
                        inline: document.querySelectorAll('style').length,
                        external: document.querySelectorAll('link[rel="stylesheet"]').length
                    }
                };
                
                // åˆ†ææ·±åº¦
                function getDepth(element, depth = 0) {
                    analysis.structure.depth = Math.max(analysis.structure.depth, depth);
                    analysis.structure.totalNodes++;
                    
                    const tag = element.tagName?.toLowerCase();
                    if (tag) {
                        analysis.structure.elementTypes[tag] = 
                            (analysis.structure.elementTypes[tag] || 0) + 1;
                    }
                    
                    for (let child of element.children) {
                        getDepth(child, depth + 1);
                    }
                }
                
                if (document.body) {
                    getDepth(document.body);
                }
                
                // å†…å®¹ç»Ÿè®¡
                analysis.content.links = document.getElementsByTagName('a').length;
                analysis.content.images = document.getElementsByTagName('img').length;
                analysis.content.forms = document.getElementsByTagName('form').length;
                
                // æ–‡æœ¬ç»Ÿè®¡
                const walker = document.createTreeWalker(
                    document.body || document,
                    NodeFilter.SHOW_TEXT
                );
                
                while (walker.nextNode()) {
                    const text = walker.currentNode.textContent.trim();
                    if (text) {
                        analysis.content.totalText += text.length;
                    }
                }
                
                return analysis;
            })()
        """,
        "returnByValue": True
    })
    
    if 'result' in result and 'result' in result['result']:
        analysis = result['result']['result']['value']
        print(f"\n  DOM åˆ†æç»“æœ:")
        print(f"    ç»“æ„:")
        print(f"      æœ€å¤§æ·±åº¦: {analysis['structure']['depth']}")
        print(f"      æ€»èŠ‚ç‚¹æ•°: {analysis['structure']['totalNodes']}")
        print(f"      å…ƒç´ ç±»å‹: {len(analysis['structure']['elementTypes'])} ç§")
        
        print(f"\n    å†…å®¹:")
        print(f"      æ–‡æœ¬é•¿åº¦: {analysis['content']['totalText']} å­—ç¬¦")
        print(f"      é“¾æ¥: {analysis['content']['links']}")
        print(f"      å›¾ç‰‡: {analysis['content']['images']}")
        print(f"      è¡¨å•: {analysis['content']['forms']}")
        
        print(f"\n    è„šæœ¬:")
        print(f"      å†…è”: {analysis['scripts']['inline']}")
        print(f"      å¤–éƒ¨: {analysis['scripts']['external']}")
        
        print(f"\n    æ ·å¼:")
        print(f"      å†…è”: {analysis['styles']['inline']}")
        print(f"      å¤–éƒ¨: {analysis['styles']['external']}")
    
    # 6. æ˜¾ç¤ºè°ƒè¯•ç»Ÿè®¡
    print("\n" + "="*60)
    print("ğŸ“Š è°ƒè¯•ä¼šè¯ç»Ÿè®¡:")
    print(f"    æ‰§è¡Œæ¬¡æ•°: {debug_state['execution_count']}")
    print(f"    æ§åˆ¶å°æ—¥å¿—: {len(debug_state['console_logs'])}")
    print(f"    æ•è·å¼‚å¸¸: {len(debug_state['exceptions'])}")
    
    if debug_state['console_logs']:
        print(f"\n  æ§åˆ¶å°æ—¥å¿—ç±»å‹:")
        log_types = {}
        for log in debug_state['console_logs']:
            t = log['type']
            log_types[t] = log_types.get(t, 0) + 1
        for t, count in log_types.items():
            print(f"      {t}: {count}")
    
    if debug_state['exceptions']:
        print(f"\n  å¼‚å¸¸åˆ—è¡¨:")
        for i, exc in enumerate(debug_state['exceptions'], 1):
            print(f"      {i}. {exc['text']}")
    
    print("="*60)
    
    runtime.close()


# ========================================
# ä¸»å‡½æ•°
# ========================================
if __name__ == "__main__":
    print("\n" + "="*60)
    print("CDP Runtime åŸŸå®Œæ•´ç¤ºä¾‹é›†")
    print("="*60)
    print("\nè¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨:")
    print("chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug")
    print("\né€‰æ‹©è¦è¿è¡Œçš„ç¤ºä¾‹:")
    print("1. åŸºç¡€ JavaScript æ‰§è¡Œ")
    print("2. å¯¹è±¡å±æ€§æ£€æŸ¥")
    print("3. æ§åˆ¶å°æ¶ˆæ¯å¤„ç†")
    print("4. æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†")
    print("5. é«˜çº§ JavaScript æ“ä½œ")
    print("6. å¼‚æ­¥æ“ä½œå’Œ Promise")
    print("7. JavaScript è°ƒè¯•å·¥å…·ï¼ˆç»¼åˆï¼‰")
    print("0. è¿è¡Œæ‰€æœ‰ç¤ºä¾‹")
    
    try:
        choice = input("\nè¯·è¾“å…¥é€‰æ‹© (0-7): ").strip()
        
        examples = {
            "1": example_basic_evaluation,
            "2": example_object_inspection,
            "3": example_console_handling,
            "4": example_execution_contexts,
            "5": example_advanced_operations,
            "6": example_async_operations,
            "7": example_debug_tool
        }
        
        if choice == "0":
            for name, example in examples.items():
                print(f"\n{'='*60}")
                print(f"è¿è¡Œç¤ºä¾‹ {name}...")
                print(f"{'='*60}")
                example()
                time.sleep(3)
        elif choice in examples:
            examples[choice]()
        else:
            print("æ— æ•ˆé€‰æ‹©")
        
        print("\nâœ… ç¤ºä¾‹æ‰§è¡Œå®Œæˆï¼")
        
    except requests.exceptions.ConnectionError:
        print("\nâŒ é”™è¯¯: æ— æ³•è¿æ¥åˆ° Chrome")
        print("è¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ --remote-debugging-port=9222 å¯åŠ¨")
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
```
