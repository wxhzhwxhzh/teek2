---
id: intro2
permalink: /cdp/p2
title: 'Fetch æ•™ç¨‹'
---


# Fetch æ•™ç¨‹
```python
import json
import websocket
import requests
import time
import base64
import threading

def get_websocket_url(port=9222):
    """è·å– WebSocket è°ƒè¯• URL"""
    response = requests.get(f'http://localhost:{port}/json')
    tabs = response.json()
    return tabs[0]['webSocketDebuggerUrl']

class CDPFetch:
    """CDP Fetch å°è£…ç±»"""
    
    def __init__(self, ws_url):
        self.ws = websocket.create_connection(ws_url)
        self.command_id = 0
        self.event_handlers = {}
        self.running = True
        
        # å¯åŠ¨äº‹ä»¶ç›‘å¬çº¿ç¨‹
        self.event_thread = threading.Thread(target=self._event_listener, daemon=True)
        self.event_thread.start()
        
    def send_command(self, method, params=None):
        """å‘é€ CDP å‘½ä»¤"""
        self.command_id += 1
        command = {
            "id": self.command_id,
            "method": method,
            "params": params or {}
        }
        print(f"\n>>> å‘é€å‘½ä»¤: {method}")
        if params:
            print(f"    å‚æ•°: {json.dumps(params, indent=6, ensure_ascii=False)}")
        
        self.ws.send(json.dumps(command))
        
        # ç­‰å¾…å“åº”
        while True:
            response = json.loads(self.ws.recv())
            if 'id' in response and response['id'] == self.command_id:
                print(f"<<< å“åº”: {json.dumps(response, indent=4, ensure_ascii=False)}")
                return response
            elif 'method' in response:
                # è¿™æ˜¯äº‹ä»¶ï¼Œäº¤ç»™äº‹ä»¶å¤„ç†å™¨
                self._handle_event(response)
    
    def _event_listener(self):
        """åå°ç›‘å¬äº‹ä»¶"""
        while self.running:
            try:
                self.ws.settimeout(0.1)
                message = self.ws.recv()
                data = json.loads(message)
                if 'method' in data:
                    self._handle_event(data)
            except:
                continue
    
    def _handle_event(self, event):
        """å¤„ç†äº‹ä»¶"""
        method = event['method']
        if method in self.event_handlers:
            self.event_handlers[method](event)
    
    def on_event(self, event_name, handler):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        self.event_handlers[event_name] = handler
    
    def close(self):
        self.running = False
        time.sleep(0.2)
        self.ws.close()


# ========================================
# ç¤ºä¾‹ 1: åŸºç¡€è¯·æ±‚æ‹¦æˆª
# ========================================
def example_basic_fetch():
    """
    æ¼”ç¤ºåŸºç¡€ Fetch åŠŸèƒ½:
    1. Fetch.enable - å¯ç”¨è¯·æ±‚æ‹¦æˆª
    2. ç›‘å¬ Fetch.requestPaused äº‹ä»¶
    3. Fetch.continueRequest - ç»§ç»­è¯·æ±‚
    4. Fetch.fulfillRequest - æ¨¡æ‹Ÿå“åº”
    5. Fetch.failRequest - é˜»æ­¢è¯·æ±‚
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 1: åŸºç¡€è¯·æ±‚æ‹¦æˆª")
    print("="*60)
    
    fetcher = CDPFetch(get_websocket_url())
    
    # è¯·æ±‚è®¡æ•°å™¨
    request_count = [0]
    
    def handle_request_paused(event):
        """å¤„ç†è¯·æ±‚æš‚åœäº‹ä»¶"""
        request_count[0] += 1
        params = event['params']
        request_id = params['requestId']
        request = params['request']
        
        print(f"\nğŸ”µ è¯·æ±‚è¢«æ‹¦æˆª #{request_count[0]}:")
        print(f"    URL: {request['url']}")
        print(f"    æ–¹æ³•: {request['method']}")
        print(f"    è¯·æ±‚ID: {request_id}")
        
        # ç»§ç»­è¯·æ±‚ï¼ˆä¸ä¿®æ”¹ï¼‰
        fetcher.send_command("Fetch.continueRequest", {
            "requestId": request_id
        })
    
    # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    fetcher.on_event("Fetch.requestPaused", handle_request_paused)
    
    # 1. å¯ç”¨ Fetchï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚
    fetcher.send_command("Fetch.enable", {
        "patterns": [
            {
                "urlPattern": "*",  # æ‹¦æˆªæ‰€æœ‰ URL
                "requestStage": "Request"  # åœ¨è¯·æ±‚é˜¶æ®µæ‹¦æˆª
            }
        ]
    })
    
    # 2. å¯¼èˆªåˆ°é¡µé¢è§¦å‘è¯·æ±‚
    fetcher.send_command("Page.enable")
    fetcher.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    
    # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©è¯·æ±‚å®Œæˆ
    time.sleep(3)
    
    print(f"\nâœ… æ€»å…±æ‹¦æˆªäº† {request_count[0]} ä¸ªè¯·æ±‚")
    
    fetcher.close()


# ========================================
# ç¤ºä¾‹ 2: ä¿®æ”¹è¯·æ±‚
# ========================================
def example_modify_request():
    """
    æ¼”ç¤ºä¿®æ”¹è¯·æ±‚:
    1. ä¿®æ”¹è¯·æ±‚å¤´
    2. ä¿®æ”¹è¯·æ±‚æ–¹æ³•
    3. ä¿®æ”¹ POST æ•°æ®
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 2: ä¿®æ”¹è¯·æ±‚")
    print("="*60)
    
    fetcher = CDPFetch(get_websocket_url())
    
    def handle_request_paused(event):
        params = event['params']
        request_id = params['requestId']
        request = params['request']
        
        print(f"\nğŸ”µ æ‹¦æˆªåˆ°è¯·æ±‚: {request['url']}")
        
        # ä¿®æ”¹è¯·æ±‚å¤´
        modified_headers = request.get('headers', {}).copy()
        modified_headers['X-Custom-Header'] = 'Modified by CDP'
        modified_headers['User-Agent'] = 'Custom CDP Bot/1.0'
        
        print(f"    âœï¸ æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´")
        
        # ç»§ç»­è¯·æ±‚å¹¶åº”ç”¨ä¿®æ”¹
        fetcher.send_command("Fetch.continueRequest", {
            "requestId": request_id,
            "headers": [
                {"name": k, "value": v} 
                for k, v in modified_headers.items()
            ]
        })
    
    fetcher.on_event("Fetch.requestPaused", handle_request_paused)
    
    # å¯ç”¨ Fetch
    fetcher.send_command("Fetch.enable", {
        "patterns": [{
            "urlPattern": "*",
            "requestStage": "Request"
        }]
    })
    
    fetcher.send_command("Page.enable")
    fetcher.send_command("Page.navigate", {
        "url": "https://httpbin.org/headers"
    })
    
    time.sleep(3)
    fetcher.close()


# ========================================
# ç¤ºä¾‹ 3: æ¨¡æ‹Ÿå“åº”ï¼ˆMock Responseï¼‰
# ========================================
def example_mock_response():
    """
    æ¼”ç¤ºæ¨¡æ‹Ÿå“åº”:
    1. æ‹¦æˆªç‰¹å®š URL
    2. è¿”å›è‡ªå®šä¹‰å“åº”å†…å®¹
    3. è®¾ç½®è‡ªå®šä¹‰å“åº”å¤´å’ŒçŠ¶æ€ç 
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 3: æ¨¡æ‹Ÿå“åº”")
    print("="*60)
    
    fetcher = CDPFetch(get_websocket_url())
    
    def handle_request_paused(event):
        params = event['params']
        request_id = params['requestId']
        request = params['request']
        url = request['url']
        
        print(f"\nğŸ”µ æ‹¦æˆªåˆ°è¯·æ±‚: {url}")
        
        # å¦‚æœæ˜¯ API è¯·æ±‚ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
        if 'api' in url or 'json' in url:
            print(f"    ğŸ­ è¿”å›æ¨¡æ‹Ÿå“åº”")
            
            # è‡ªå®šä¹‰å“åº”ä½“
            mock_data = {
                "status": "success",
                "message": "This is a mocked response from CDP",
                "data": {
                    "id": 123,
                    "name": "Mock User",
                    "timestamp": time.time()
                }
            }
            
            response_body = json.dumps(mock_data)
            encoded_body = base64.b64encode(response_body.encode()).decode()
            
            # è¿”å›æ¨¡æ‹Ÿå“åº”
            fetcher.send_command("Fetch.fulfillRequest", {
                "requestId": request_id,
                "responseCode": 200,
                "responseHeaders": [
                    {"name": "Content-Type", "value": "application/json"},
                    {"name": "X-Mocked-By", "value": "CDP"},
                    {"name": "Access-Control-Allow-Origin", "value": "*"}
                ],
                "body": encoded_body
            })
        else:
            # å…¶ä»–è¯·æ±‚æ­£å¸¸ç»§ç»­
            fetcher.send_command("Fetch.continueRequest", {
                "requestId": request_id
            })
    
    fetcher.on_event("Fetch.requestPaused", handle_request_paused)
    
    # å¯ç”¨ Fetch
    fetcher.send_command("Fetch.enable", {
        "patterns": [{
            "urlPattern": "*",
            "requestStage": "Request"
        }]
    })
    
    fetcher.send_command("Page.enable")
    fetcher.send_command("Runtime.enable")
    
    # å¯¼èˆªå¹¶æ‰§è¡Œ API è¯·æ±‚
    fetcher.send_command("Page.navigate", {"url": "https://example.com"})
    time.sleep(2)
    
    # æ‰§è¡Œ fetch è¯·æ±‚
    fetcher.send_command("Runtime.evaluate", {
        "expression": """
            fetch('https://api.example.com/users')
                .then(r => r.json())
                .then(data => console.log('Response:', data))
        """
    })
    
    time.sleep(2)
    fetcher.close()


# ========================================
# ç¤ºä¾‹ 4: é˜»æ­¢ç‰¹å®šè¯·æ±‚
# ========================================
def example_block_requests():
    """
    æ¼”ç¤ºé˜»æ­¢è¯·æ±‚:
    1. é˜»æ­¢å¹¿å‘Š
    2. é˜»æ­¢è¿½è¸ªè„šæœ¬
    3. é˜»æ­¢å›¾ç‰‡åŠ è½½
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 4: é˜»æ­¢ç‰¹å®šè¯·æ±‚")
    print("="*60)
    
    fetcher = CDPFetch(get_websocket_url())
    
    # é»‘åå•æ¨¡å¼
    blocked_patterns = [
        'ads',
        'analytics',
        'tracking',
        'doubleclick',
        'googletagmanager'
    ]
    
    blocked_count = [0]
    allowed_count = [0]
    
    def handle_request_paused(event):
        params = event['params']
        request_id = params['requestId']
        request = params['request']
        url = request['url'].lower()
        
        # æ£€æŸ¥æ˜¯å¦åº”è¯¥é˜»æ­¢
        should_block = any(pattern in url for pattern in blocked_patterns)
        
        if should_block:
            blocked_count[0] += 1
            print(f"\nğŸš« é˜»æ­¢è¯·æ±‚ #{blocked_count[0]}: {request['url'][:80]}")
            
            # é˜»æ­¢è¯·æ±‚
            fetcher.send_command("Fetch.failRequest", {
                "requestId": request_id,
                "errorReason": "BlockedByClient"
            })
        else:
            allowed_count[0] += 1
            print(f"\nâœ… å…è®¸è¯·æ±‚ #{allowed_count[0]}: {request['url'][:80]}")
            
            # ç»§ç»­è¯·æ±‚
            fetcher.send_command("Fetch.continueRequest", {
                "requestId": request_id
            })
    
    fetcher.on_event("Fetch.requestPaused", handle_request_paused)
    
    # å¯ç”¨ Fetch
    fetcher.send_command("Fetch.enable", {
        "patterns": [{
            "urlPattern": "*",
            "requestStage": "Request"
        }]
    })
    
    fetcher.send_command("Page.enable")
    fetcher.send_command("Page.navigate", {
        "url": "https://www.nytimes.com"  # é€šå¸¸åŒ…å«å¹¿å‘Šå’Œè¿½è¸ª
    })
    
    time.sleep(5)
    
    print(f"\n" + "="*60)
    print(f"ğŸ“Š ç»Ÿè®¡:")
    print(f"    é˜»æ­¢: {blocked_count[0]} ä¸ªè¯·æ±‚")
    print(f"    å…è®¸: {allowed_count[0]} ä¸ªè¯·æ±‚")
    print("="*60)
    
    fetcher.close()


# ========================================
# ç¤ºä¾‹ 5: æ‹¦æˆªå“åº”ï¼ˆResponse Stageï¼‰
# ========================================
def example_intercept_response():
    """
    æ¼”ç¤ºæ‹¦æˆªå“åº”:
    1. åœ¨å“åº”é˜¶æ®µæ‹¦æˆª
    2. Fetch.getResponseBody - è·å–å“åº”ä½“
    3. ä¿®æ”¹å“åº”å†…å®¹
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 5: æ‹¦æˆªå’Œä¿®æ”¹å“åº”")
    print("="*60)
    
    fetcher = CDPFetch(get_websocket_url())
    
    def handle_request_paused(event):
        params = event['params']
        request_id = params['requestId']
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯å“åº”é˜¶æ®µ
        if 'responseStatusCode' in params:
            print(f"\nğŸ”µ æ‹¦æˆªåˆ°å“åº”:")
            print(f"    çŠ¶æ€ç : {params['responseStatusCode']}")
            print(f"    URL: {params['request']['url'][:80]}")
            
            # è·å–åŸå§‹å“åº”ä½“
            try:
                response = fetcher.send_command("Fetch.getResponseBody", {
                    "requestId": request_id
                })
                
                if 'result' in response and 'body' in response['result']:
                    original_body = response['result']['body']
                    
                    # å¦‚æœæ˜¯ base64 ç¼–ç 
                    if response['result'].get('base64Encoded'):
                        original_body = base64.b64decode(original_body).decode('utf-8')
                    
                    print(f"    åŸå§‹å“åº”å¤§å°: {len(original_body)} å­—èŠ‚")
                    
                    # ä¿®æ”¹å“åº”å†…å®¹
                    modified_body = original_body.replace(
                        '</body>',
                        '<script>console.log("Injected by CDP!");</script></body>'
                    )
                    
                    encoded_body = base64.b64encode(modified_body.encode()).decode()
                    
                    # è¿”å›ä¿®æ”¹åçš„å“åº”
                    fetcher.send_command("Fetch.fulfillRequest", {
                        "requestId": request_id,
                        "responseCode": params['responseStatusCode'],
                        "responseHeaders": params.get('responseHeaders', []),
                        "body": encoded_body
                    })
                    
                    print(f"    âœï¸ å·²æ³¨å…¥è‡ªå®šä¹‰è„šæœ¬")
                    return
            except Exception as e:
                print(f"    âš ï¸ æ— æ³•è·å–å“åº”ä½“: {e}")
        
        # é»˜è®¤ç»§ç»­
        fetcher.send_command("Fetch.continueRequest", {
            "requestId": request_id
        })
    
    fetcher.on_event("Fetch.requestPaused", handle_request_paused)
    
    # å¯ç”¨ Fetchï¼Œåœ¨å“åº”é˜¶æ®µæ‹¦æˆª HTML
    fetcher.send_command("Fetch.enable", {
        "patterns": [{
            "urlPattern": "*",
            "resourceType": "Document",  # åªæ‹¦æˆª HTML æ–‡æ¡£
            "requestStage": "Response"   # åœ¨å“åº”é˜¶æ®µæ‹¦æˆª
        }]
    })
    
    fetcher.send_command("Page.enable")
    fetcher.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    
    time.sleep(3)
    fetcher.close()


# ========================================
# ç¤ºä¾‹ 6: ç»¼åˆåº”ç”¨ - HTTP ä»£ç†åŠŸèƒ½
# ========================================
def example_http_proxy():
    """
    ç»¼åˆç¤ºä¾‹: å®ç°ç±»ä¼¼ HTTP ä»£ç†çš„åŠŸèƒ½
    1. è®°å½•æ‰€æœ‰è¯·æ±‚/å“åº”
    2. ä¿®æ”¹ç‰¹å®šè¯·æ±‚
    3. ç¼“å­˜å“åº”
    4. ç»Ÿè®¡åˆ†æ
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 6: HTTP ä»£ç†åŠŸèƒ½")
    print("="*60)
    
    fetcher = CDPFetch(get_websocket_url())
    
    # ç»Ÿè®¡æ•°æ®
    stats = {
        "total_requests": 0,
        "blocked": 0,
        "modified": 0,
        "cached": 0,
        "by_type": {}
    }
    
    # ç®€å•çš„å“åº”ç¼“å­˜
    response_cache = {}
    
    def handle_request_paused(event):
        params = event['params']
        request_id = params['requestId']
        request = params['request']
        url = request['url']
        resource_type = params.get('resourceType', 'Other')
        
        stats["total_requests"] += 1
        stats["by_type"][resource_type] = stats["by_type"].get(resource_type, 0) + 1
        
        print(f"\nğŸ“¦ è¯·æ±‚ #{stats['total_requests']}")
        print(f"    ç±»å‹: {resource_type}")
        print(f"    URL: {url[:100]}")
        
        # æ£€æŸ¥ç¼“å­˜
        if url in response_cache:
            stats["cached"] += 1
            print(f"    ğŸ’¾ ä½¿ç”¨ç¼“å­˜")
            
            cached = response_cache[url]
            fetcher.send_command("Fetch.fulfillRequest", cached)
            return
        
        # é˜»æ­¢å›¾ç‰‡è¯·æ±‚ï¼ˆç¤ºä¾‹ï¼‰
        if resource_type == "Image":
            stats["blocked"] += 1
            print(f"    ğŸš« é˜»æ­¢å›¾ç‰‡")
            fetcher.send_command("Fetch.failRequest", {
                "requestId": request_id,
                "errorReason": "BlockedByClient"
            })
            return
        
        # ä¿®æ”¹ JavaScript è¯·æ±‚ï¼ˆç¤ºä¾‹ï¼‰
        if resource_type == "Script":
            stats["modified"] += 1
            modified_headers = [
                {"name": k, "value": v}
                for k, v in request.get('headers', {}).items()
            ]
            modified_headers.append(
                {"name": "X-Script-Modified", "value": "true"}
            )
            
            print(f"    âœï¸ ä¿®æ”¹è„šæœ¬è¯·æ±‚å¤´")
            fetcher.send_command("Fetch.continueRequest", {
                "requestId": request_id,
                "headers": modified_headers
            })
            return
        
        # å…¶ä»–è¯·æ±‚æ­£å¸¸ç»§ç»­
        fetcher.send_command("Fetch.continueRequest", {
            "requestId": request_id
        })
    
    fetcher.on_event("Fetch.requestPaused", handle_request_paused)
    
    # å¯ç”¨å®Œæ•´çš„è¯·æ±‚æ‹¦æˆª
    fetcher.send_command("Fetch.enable", {
        "patterns": [{
            "urlPattern": "*",
            "requestStage": "Request"
        }],
        "handleAuthRequests": True
    })
    
    fetcher.send_command("Page.enable")
    fetcher.send_command("Page.navigate", {
        "url": "https://news.ycombinator.com"
    })
    
    time.sleep(5)
    
    # æ˜¾ç¤ºç»Ÿè®¡
    print("\n" + "="*60)
    print("ğŸ“Š ä»£ç†ç»Ÿè®¡:")
    print(f"    æ€»è¯·æ±‚æ•°: {stats['total_requests']}")
    print(f"    å·²é˜»æ­¢: {stats['blocked']}")
    print(f"    å·²ä¿®æ”¹: {stats['modified']}")
    print(f"    ä½¿ç”¨ç¼“å­˜: {stats['cached']}")
    print(f"\næŒ‰ç±»å‹åˆ†ç»„:")
    for res_type, count in sorted(stats['by_type'].items(), key=lambda x: -x[1]):
        print(f"    {res_type}: {count}")
    print("="*60)
    
    fetcher.close()


# ========================================
# ä¸»å‡½æ•°
# ========================================
if __name__ == "__main__":
    print("\n" + "="*60)
    print("CDP Fetch.enable å®Œæ•´ç¤ºä¾‹é›†")
    print("="*60)
    print("\nè¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨:")
    print("chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug")
    print("\né€‰æ‹©è¦è¿è¡Œçš„ç¤ºä¾‹:")
    print("1. åŸºç¡€è¯·æ±‚æ‹¦æˆª")
    print("2. ä¿®æ”¹è¯·æ±‚")
    print("3. æ¨¡æ‹Ÿå“åº”")
    print("4. é˜»æ­¢ç‰¹å®šè¯·æ±‚")
    print("5. æ‹¦æˆªå’Œä¿®æ”¹å“åº”")
    print("6. HTTP ä»£ç†åŠŸèƒ½")
    print("0. è¿è¡Œæ‰€æœ‰ç¤ºä¾‹")
    
    try:
        choice = input("\nè¯·è¾“å…¥é€‰æ‹© (0-6): ").strip()
        
        examples = {
            "1": example_basic_fetch,
            "2": example_modify_request,
            "3": example_mock_response,
            "4": example_block_requests,
            "5": example_intercept_response,
            "6": example_http_proxy
        }
        
        if choice == "0":
            for example in examples.values():
                example()
                time.sleep(2)
        elif choice in examples:
            examples[choice]()
        else:
            print("æ— æ•ˆé€‰æ‹©")
        
        print("\nâœ… ç¤ºä¾‹æ‰§è¡Œå®Œæˆï¼")
        
    except requests.exceptions.ConnectionError:
        print("\nâŒ é”™è¯¯: æ— æ³•è¿æ¥åˆ° Chrome")
        print("è¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ --remote-debugging-port=9222 å¯åŠ¨")
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
```
