---
id: intro4
permalink: /cdp/p4
title: 'Target'
---


# Targetæ•™ç¨‹
```python
  import json
import websocket
import requests
import time
import threading
from datetime import datetime

def get_websocket_url(port=9222):
    """è·å–ä¸»æµè§ˆå™¨ WebSocket è°ƒè¯• URL"""
    response = requests.get(f'http://localhost:{port}/json')
    tabs = response.json()
    return tabs[0]['webSocketDebuggerUrl']

def get_browser_websocket_url(port=9222):
    """è·å–æµè§ˆå™¨çº§åˆ«çš„ WebSocket URL"""
    response = requests.get(f'http://localhost:{port}/json/version')
    version_info = response.json()
    return version_info['webSocketDebuggerUrl']

class CDPTarget:
    """CDP Target å°è£…ç±»"""
    
    def __init__(self, ws_url):
        self.ws = websocket.create_connection(ws_url)
        self.command_id = 0
        self.event_handlers = {}
        self.running = True
        self.events_log = []
        self.targets = {}  # å­˜å‚¨æ‰€æœ‰ target ä¿¡æ¯
        
        # å¯åŠ¨äº‹ä»¶ç›‘å¬çº¿ç¨‹
        self.event_thread = threading.Thread(target=self._event_listener, daemon=True)
        self.event_thread.start()
        
    def send_command(self, method, params=None):
        """å‘é€ CDP å‘½ä»¤"""
        self.command_id += 1
        command = {
            "id": self.command_id,
            "method": method,
            "params": params or {}
        }
        print(f"\n>>> å‘é€å‘½ä»¤: {method}")
        if params:
            # æˆªæ–­è¿‡é•¿çš„å‚æ•°æ˜¾ç¤º
            params_str = json.dumps(params, indent=6, ensure_ascii=False)
            if len(params_str) > 300:
                params_str = params_str[:300] + "..."
            print(f"    å‚æ•°: {params_str}")
        
        self.ws.send(json.dumps(command))
        
        # ç­‰å¾…å“åº”
        while True:
            try:
                response = json.loads(self.ws.recv())
                if 'id' in response and response['id'] == self.command_id:
                    if 'error' not in response:
                        print(f"<<< å“åº”æˆåŠŸ")
                        if 'result' in response and response['result']:
                            result_str = json.dumps(response['result'], indent=6, ensure_ascii=False)
                            if len(result_str) > 300:
                                result_str = result_str[:300] + "..."
                            print(f"    ç»“æœ: {result_str}")
                    else:
                        print(f"<<< é”™è¯¯: {response['error']}")
                    return response
                elif 'method' in response:
                    self._handle_event(response)
            except Exception as e:
                print(f"    âš ï¸ æ¥æ”¶å“åº”å‡ºé”™: {e}")
                return {"error": str(e)}
    
    def _event_listener(self):
        """åå°ç›‘å¬äº‹ä»¶"""
        while self.running:
            try:
                self.ws.settimeout(0.1)
                message = self.ws.recv()
                data = json.loads(message)
                if 'method' in data:
                    self._handle_event(data)
            except:
                continue
    
    def _handle_event(self, event):
        """å¤„ç†äº‹ä»¶"""
        method = event['method']
        self.events_log.append({
            'timestamp': datetime.now().isoformat(),
            'method': method,
            'params': event.get('params', {})
        })
        
        if method in self.event_handlers:
            self.event_handlers[method](event)
    
    def on_event(self, event_name, handler):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        self.event_handlers[event_name] = handler
    
    def wait_for_event(self, event_name, timeout=10):
        """ç­‰å¾…ç‰¹å®šäº‹ä»¶"""
        start_time = time.time()
        while time.time() - start_time < timeout:
            for event in reversed(self.events_log):
                if event['method'] == event_name:
                    return event
            time.sleep(0.1)
        return None
    
    def close(self):
        self.running = False
        time.sleep(0.2)
        self.ws.close()


# ========================================
# ç¤ºä¾‹ 1: åŸºç¡€ Target å‘ç°å’Œä¿¡æ¯è·å–
# ========================================
def example_target_discovery():
    """
    æ¼”ç¤º Target å‘ç°:
    1. Target.setDiscoverTargets - å¯ç”¨ target å‘ç°
    2. Target.getTargets - è·å–æ‰€æœ‰ targets
    3. Target.getTargetInfo - è·å–å•ä¸ª target ä¿¡æ¯
    4. Target.targetCreated - target åˆ›å»ºäº‹ä»¶
    5. Target.targetDestroyed - target é”€æ¯äº‹ä»¶
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 1: Target å‘ç°å’Œä¿¡æ¯è·å–")
    print("="*60)
    
    # ä½¿ç”¨æµè§ˆå™¨çº§åˆ«çš„è¿æ¥
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    created_count = [0]
    destroyed_count = [0]
    
    def handle_target_created(event):
        created_count[0] += 1
        info = event['params']['targetInfo']
        print(f"\nğŸ†• Target åˆ›å»º #{created_count[0]}:")
        print(f"    ID: {info.get('targetId', 'N/A')[:40]}...")
        print(f"    ç±»å‹: {info.get('type', 'N/A')}")
        print(f"    URL: {info.get('url', 'N/A')[:80]}")
        print(f"    æ ‡é¢˜: {info.get('title', 'N/A')[:50]}")
    
    def handle_target_destroyed(event):
        destroyed_count[0] += 1
        target_id = event['params']['targetId']
        print(f"\nâŒ Target é”€æ¯ #{destroyed_count[0]}: {target_id[:40]}...")
    
    def handle_target_info_changed(event):
        info = event['params']['targetInfo']
        print(f"\nğŸ”„ Target ä¿¡æ¯å˜åŒ–:")
        print(f"    ID: {info.get('targetId', 'N/A')[:40]}...")
        print(f"    URL: {info.get('url', 'N/A')[:80]}")
    
    # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    target.on_event("Target.targetCreated", handle_target_created)
    target.on_event("Target.targetDestroyed", handle_target_destroyed)
    target.on_event("Target.targetInfoChanged", handle_target_info_changed)
    
    # 1. å¯ç”¨ target å‘ç°
    print("\n--- å¯ç”¨ Target å‘ç° ---")
    target.send_command("Target.setDiscoverTargets", {
        "discover": True
    })
    
    time.sleep(2)
    
    # 2. è·å–æ‰€æœ‰ targets
    print("\n--- è·å–æ‰€æœ‰ Targets ---")
    result = target.send_command("Target.getTargets")
    
    if 'result' in result and 'targetInfos' in result['result']:
        targets = result['result']['targetInfos']
        print(f"\nğŸ“Š å½“å‰æ´»è·ƒçš„ Targets (å…± {len(targets)} ä¸ª):")
        
        for i, info in enumerate(targets, 1):
            print(f"\n  {i}. Target:")
            print(f"     ID: {info.get('targetId', 'N/A')[:40]}...")
            print(f"     ç±»å‹: {info.get('type', 'N/A')}")
            print(f"     URL: {info.get('url', 'N/A')[:80]}")
            print(f"     æ ‡é¢˜: {info.get('title', 'N/A')[:50]}")
            print(f"     å·²é™„åŠ : {info.get('attached', False)}")
    
    # 3. åˆ›å»ºæ–°æ ‡ç­¾é¡µè§¦å‘äº‹ä»¶
    print("\n--- åˆ›å»ºæ–°æ ‡ç­¾é¡µ ---")
    new_target = target.send_command("Target.createTarget", {
        "url": "https://example.com"
    })
    
    time.sleep(3)
    
    # 4. å…³é—­æ–°åˆ›å»ºçš„æ ‡ç­¾é¡µ
    if 'result' in new_target and 'targetId' in new_target['result']:
        target_id = new_target['result']['targetId']
        print(f"\n--- å…³é—­æ ‡ç­¾é¡µ {target_id[:40]}... ---")
        target.send_command("Target.closeTarget", {
            "targetId": target_id
        })
    
    time.sleep(2)
    
    print(f"\nğŸ“Š ç»Ÿè®¡: åˆ›å»º {created_count[0]} ä¸ª, é”€æ¯ {destroyed_count[0]} ä¸ª")
    
    target.close()


# ========================================
# ç¤ºä¾‹ 2: åˆ›å»ºå’Œç®¡ç† Targets
# ========================================
def example_create_and_manage_targets():
    """
    æ¼”ç¤ºåˆ›å»ºå’Œç®¡ç† targets:
    1. Target.createTarget - åˆ›å»ºæ–°æ ‡ç­¾é¡µ
    2. Target.closeTarget - å…³é—­æ ‡ç­¾é¡µ
    3. Target.activateTarget - æ¿€æ´»æ ‡ç­¾é¡µ
    4. Target.createBrowserContext - åˆ›å»ºéš”ç¦»ä¸Šä¸‹æ–‡
    5. Target.disposeBrowserContext - é”€æ¯ä¸Šä¸‹æ–‡
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 2: åˆ›å»ºå’Œç®¡ç† Targets")
    print("="*60)
    
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    target.send_command("Target.setDiscoverTargets", {"discover": True})
    time.sleep(1)
    
    # 1. åˆ›å»ºæ™®é€šæ ‡ç­¾é¡µ
    print("\n--- åˆ›å»ºæ™®é€šæ ‡ç­¾é¡µ ---")
    tab1 = target.send_command("Target.createTarget", {
        "url": "https://www.google.com",
        "width": 1024,
        "height": 768,
        "enableBeginFrameControl": False
    })
    
    tab1_id = tab1['result']['targetId'] if 'result' in tab1 else None
    print(f"    åˆ›å»ºçš„ Target ID: {tab1_id[:40] if tab1_id else 'N/A'}...")
    time.sleep(2)
    
    # 2. åˆ›å»ºéš”ç¦»çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
    print("\n--- åˆ›å»ºéš”ç¦»æµè§ˆå™¨ä¸Šä¸‹æ–‡ ---")
    context = target.send_command("Target.createBrowserContext", {
        "disposeOnDetach": True,  # æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨é”€æ¯
        "proxyServer": "",         # å¯é€‰ï¼šè®¾ç½®ä»£ç†
        "proxyBypassList": ""      # å¯é€‰ï¼šä»£ç†ç»•è¿‡åˆ—è¡¨
    })
    
    context_id = context['result']['browserContextId'] if 'result' in context else None
    print(f"    ä¸Šä¸‹æ–‡ ID: {context_id[:40] if context_id else 'N/A'}...")
    
    # 3. åœ¨éš”ç¦»ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºæ ‡ç­¾é¡µ
    if context_id:
        print("\n--- åœ¨éš”ç¦»ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºæ ‡ç­¾é¡µ ---")
        tab2 = target.send_command("Target.createTarget", {
            "url": "https://www.wikipedia.org",
            "browserContextId": context_id
        })
        
        tab2_id = tab2['result']['targetId'] if 'result' in tab2 else None
        print(f"    åˆ›å»ºçš„ Target ID: {tab2_id[:40] if tab2_id else 'N/A'}...")
        time.sleep(2)
    
    # 4. æ¿€æ´»ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
    if tab1_id:
        print("\n--- æ¿€æ´»ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ ---")
        target.send_command("Target.activateTarget", {
            "targetId": tab1_id
        })
        time.sleep(1)
    
    # 5. è·å–å½“å‰æ‰€æœ‰ targets
    print("\n--- å½“å‰æ‰€æœ‰ Targets ---")
    all_targets = target.send_command("Target.getTargets")
    if 'result' in all_targets:
        print(f"    æ€»æ•°: {len(all_targets['result']['targetInfos'])}")
    
    # 6. å…³é—­åˆ›å»ºçš„æ ‡ç­¾é¡µ
    print("\n--- æ¸…ç†: å…³é—­åˆ›å»ºçš„æ ‡ç­¾é¡µ ---")
    if tab1_id:
        target.send_command("Target.closeTarget", {"targetId": tab1_id})
        print(f"    å·²å…³é—­: {tab1_id[:40]}...")
    
    # 7. é”€æ¯æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆä¼šè‡ªåŠ¨å…³é—­å…¶ä¸­çš„æ‰€æœ‰æ ‡ç­¾é¡µï¼‰
    if context_id:
        print("\n--- é”€æ¯æµè§ˆå™¨ä¸Šä¸‹æ–‡ ---")
        target.send_command("Target.disposeBrowserContext", {
            "browserContextId": context_id
        })
        print(f"    å·²é”€æ¯ä¸Šä¸‹æ–‡: {context_id[:40]}...")
    
    time.sleep(2)
    target.close()


# ========================================
# ç¤ºä¾‹ 3: é™„åŠ åˆ° Target å¹¶æ§åˆ¶
# ========================================
def example_attach_and_control():
    """
    æ¼”ç¤ºé™„åŠ åˆ° target å¹¶æ§åˆ¶:
    1. Target.attachToTarget - é™„åŠ åˆ° target
    2. Target.detachFromTarget - ä» target åˆ†ç¦»
    3. Target.sendMessageToTarget - å‘ target å‘é€æ¶ˆæ¯
    4. Target.setAutoAttach - è‡ªåŠ¨é™„åŠ è®¾ç½®
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 3: é™„åŠ åˆ° Target å¹¶æ§åˆ¶")
    print("="*60)
    
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    session_ids = {}
    
    def handle_attached_to_target(event):
        params = event['params']
        session_id = params.get('sessionId')
        target_info = params.get('targetInfo', {})
        
        print(f"\nâœ… å·²é™„åŠ åˆ° Target:")
        print(f"    Session ID: {session_id[:40]}...")
        print(f"    Target ID: {target_info.get('targetId', 'N/A')[:40]}...")
        print(f"    ç±»å‹: {target_info.get('type', 'N/A')}")
        
        session_ids[target_info.get('targetId')] = session_id
    
    def handle_detached_from_target(event):
        session_id = event['params'].get('sessionId')
        print(f"\nâŒ å·²ä» Target åˆ†ç¦»: {session_id[:40]}...")
    
    def handle_received_message(event):
        params = event['params']
        session_id = params.get('sessionId', '')[:20]
        message = json.loads(params.get('message', '{}'))
        method = message.get('method', 'N/A')
        
        # åªæ˜¾ç¤ºé‡è¦æ¶ˆæ¯
        if method in ['Page.loadEventFired', 'Runtime.executionContextCreated']:
            print(f"\nğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ [Session: {session_id}...]: {method}")
    
    target.on_event("Target.attachedToTarget", handle_attached_to_target)
    target.on_event("Target.detachedFromTarget", handle_detached_from_target)
    target.on_event("Target.receivedMessageFromTarget", handle_received_message)
    
    target.send_command("Target.setDiscoverTargets", {"discover": True})
    
    # 1. è®¾ç½®è‡ªåŠ¨é™„åŠ åˆ°æ–° targets
    print("\n--- è®¾ç½®è‡ªåŠ¨é™„åŠ  ---")
    target.send_command("Target.setAutoAttach", {
        "autoAttach": True,
        "waitForDebuggerOnStart": False,
        "flatten": True  # æ‰å¹³åŒ–ï¼ŒåŒ…æ‹¬ iframe ç­‰
    })
    
    time.sleep(1)
    
    # 2. åˆ›å»ºæ–°æ ‡ç­¾é¡µï¼ˆä¼šè‡ªåŠ¨é™„åŠ ï¼‰
    print("\n--- åˆ›å»ºæ–°æ ‡ç­¾é¡µï¼ˆè‡ªåŠ¨é™„åŠ ï¼‰---")
    new_tab = target.send_command("Target.createTarget", {
        "url": "https://example.com"
    })
    
    tab_id = new_tab['result']['targetId'] if 'result' in new_tab else None
    time.sleep(3)
    
    # 3. é€šè¿‡ session å‘ target å‘é€å‘½ä»¤
    if tab_id and tab_id in session_ids:
        session_id = session_ids[tab_id]
        
        print(f"\n--- å‘ Target å‘é€å‘½ä»¤ ---")
        print(f"    Session ID: {session_id[:40]}...")
        
        # å¯ç”¨ Page åŸŸ
        message = {
            "id": 1,
            "method": "Page.enable",
            "params": {}
        }
        
        target.send_command("Target.sendMessageToTarget", {
            "sessionId": session_id,
            "message": json.dumps(message)
        })
        
        time.sleep(1)
        
        # å¯¼èˆªåˆ°æ–° URL
        message = {
            "id": 2,
            "method": "Page.navigate",
            "params": {"url": "https://www.wikipedia.org"}
        }
        
        target.send_command("Target.sendMessageToTarget", {
            "sessionId": session_id,
            "message": json.dumps(message)
        })
        
        time.sleep(3)
        
        # 4. æ‰‹åŠ¨ä» target åˆ†ç¦»
        print(f"\n--- æ‰‹åŠ¨åˆ†ç¦» ---")
        target.send_command("Target.detachFromTarget", {
            "sessionId": session_id
        })
    
    # 5. æ¸…ç†
    if tab_id:
        print(f"\n--- å…³é—­æ ‡ç­¾é¡µ ---")
        target.send_command("Target.closeTarget", {"targetId": tab_id})
    
    time.sleep(2)
    target.close()


# ========================================
# ç¤ºä¾‹ 4: å¤šæ ‡ç­¾é¡µå¹¶è¡Œæ“ä½œ
# ========================================
def example_parallel_tabs():
    """
    æ¼”ç¤ºå¤šæ ‡ç­¾é¡µå¹¶è¡Œæ“ä½œ:
    1. åˆ›å»ºå¤šä¸ªæ ‡ç­¾é¡µ
    2. åŒæ—¶æ§åˆ¶å¤šä¸ªæ ‡ç­¾é¡µ
    3. æ”¶é›†å¤šä¸ªæ ‡ç­¾é¡µçš„ç»“æœ
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 4: å¤šæ ‡ç­¾é¡µå¹¶è¡Œæ“ä½œ")
    print("="*60)
    
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    target.send_command("Target.setDiscoverTargets", {"discover": True})
    target.send_command("Target.setAutoAttach", {
        "autoAttach": True,
        "waitForDebuggerOnStart": False,
        "flatten": True
    })
    
    urls = [
        "https://example.com",
        "https://www.wikipedia.org",
        "https://news.ycombinator.com"
    ]
    
    tabs = []
    sessions = {}
    
    def handle_attached(event):
        session_id = event['params']['sessionId']
        target_id = event['params']['targetInfo']['targetId']
        sessions[target_id] = session_id
    
    target.on_event("Target.attachedToTarget", handle_attached)
    
    # 1. åˆ›å»ºå¤šä¸ªæ ‡ç­¾é¡µ
    print(f"\n--- åˆ›å»º {len(urls)} ä¸ªæ ‡ç­¾é¡µ ---")
    for i, url in enumerate(urls, 1):
        print(f"    åˆ›å»ºæ ‡ç­¾é¡µ {i}: {url}")
        result = target.send_command("Target.createTarget", {"url": url})
        if 'result' in result:
            tabs.append({
                'targetId': result['result']['targetId'],
                'url': url
            })
    
    time.sleep(4)
    
    # 2. å¯¹æ¯ä¸ªæ ‡ç­¾é¡µæ‰§è¡Œæ“ä½œ
    print(f"\n--- å¹¶è¡Œæ“ä½œ {len(tabs)} ä¸ªæ ‡ç­¾é¡µ ---")
    for i, tab in enumerate(tabs, 1):
        target_id = tab['targetId']
        if target_id in sessions:
            session_id = sessions[target_id]
            
            print(f"\n  æ“ä½œæ ‡ç­¾é¡µ {i} [Session: {session_id[:20]}...]")
            
            # å¯ç”¨ Runtime
            target.send_command("Target.sendMessageToTarget", {
                "sessionId": session_id,
                "message": json.dumps({
                    "id": 100 + i,
                    "method": "Runtime.enable",
                    "params": {}
                })
            })
            
            # æ‰§è¡Œ JavaScript
            target.send_command("Target.sendMessageToTarget", {
                "sessionId": session_id,
                "message": json.dumps({
                    "id": 200 + i,
                    "method": "Runtime.evaluate",
                    "params": {
                        "expression": f"console.log('æ ‡ç­¾é¡µ {i} æ­£åœ¨æ‰§è¡Œ')"
                    }
                })
            })
    
    time.sleep(2)
    
    # 3. æ”¶é›†ä¿¡æ¯
    print(f"\n--- è·å–æ‰€æœ‰æ ‡ç­¾é¡µä¿¡æ¯ ---")
    all_targets = target.send_command("Target.getTargets")
    if 'result' in all_targets:
        page_targets = [
            t for t in all_targets['result']['targetInfos'] 
            if t.get('type') == 'page'
        ]
        print(f"    å½“å‰é¡µé¢ç±»å‹ Targets: {len(page_targets)} ä¸ª")
    
    # 4. æ¸…ç†æ‰€æœ‰æ ‡ç­¾é¡µ
    print(f"\n--- æ¸…ç†: å…³é—­æ‰€æœ‰åˆ›å»ºçš„æ ‡ç­¾é¡µ ---")
    for i, tab in enumerate(tabs, 1):
        target.send_command("Target.closeTarget", {
            "targetId": tab['targetId']
        })
        print(f"    å·²å…³é—­æ ‡ç­¾é¡µ {i}")
    
    time.sleep(2)
    target.close()


# ========================================
# ç¤ºä¾‹ 5: Service Worker å’Œåå° Targets
# ========================================
def example_service_workers():
    """
    æ¼”ç¤º Service Worker ç®¡ç†:
    1. å‘ç° Service Worker targets
    2. é™„åŠ åˆ° Service Worker
    3. ç›‘æ§ Worker ç”Ÿå‘½å‘¨æœŸ
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 5: Service Worker å’Œåå° Targets")
    print("="*60)
    
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    worker_targets = []
    
    def handle_target_created(event):
        info = event['params']['targetInfo']
        target_type = info.get('type')
        
        if target_type in ['service_worker', 'worker', 'shared_worker']:
            worker_targets.append(info)
            print(f"\nğŸ‘· å‘ç° Worker:")
            print(f"    ç±»å‹: {target_type}")
            print(f"    URL: {info.get('url', 'N/A')[:80]}")
            print(f"    Target ID: {info.get('targetId', 'N/A')[:40]}...")
    
    target.on_event("Target.targetCreated", handle_target_created)
    
    # 1. å¯ç”¨å‘ç°
    target.send_command("Target.setDiscoverTargets", {"discover": True})
    time.sleep(1)
    
    # 2. è·å–æ‰€æœ‰ targets å¹¶è¿‡æ»¤ workers
    print("\n--- æ‰«æç°æœ‰ Targets ---")
    all_targets = target.send_command("Target.getTargets")
    
    if 'result' in all_targets:
        targets_by_type = {}
        for info in all_targets['result']['targetInfos']:
            t_type = info.get('type', 'unknown')
            targets_by_type[t_type] = targets_by_type.get(t_type, 0) + 1
        
        print(f"\nğŸ“Š Targets åˆ†ç±»ç»Ÿè®¡:")
        for t_type, count in sorted(targets_by_type.items()):
            print(f"    {t_type}: {count}")
        
        # æ˜¾ç¤ºæ‰€æœ‰ worker ç±»å‹çš„ targets
        worker_types = ['service_worker', 'worker', 'shared_worker']
        workers = [
            t for t in all_targets['result']['targetInfos']
            if t.get('type') in worker_types
        ]
        
        if workers:
            print(f"\nğŸ‘· å½“å‰æ´»è·ƒçš„ Workers ({len(workers)} ä¸ª):")
            for i, worker in enumerate(workers, 1):
                print(f"\n  {i}. {worker.get('type', 'N/A')}")
                print(f"     URL: {worker.get('url', 'N/A')[:80]}")
                print(f"     Title: {worker.get('title', 'N/A')}")
        else:
            print(f"\n    æš‚æ— æ´»è·ƒçš„ Workers")
    
    # 3. åˆ›å»ºä¸€ä¸ªåŒ…å« Service Worker çš„é¡µé¢
    print("\n--- åˆ›å»ºåŒ…å« Service Worker çš„æµ‹è¯•é¡µé¢ ---")
    test_tab = target.send_command("Target.createTarget", {
        "url": "https://mdn.github.io/sw-test/"  # ä¸€ä¸ªæœ‰ Service Worker çš„ç¤ºä¾‹
    })
    
    print("    ç­‰å¾… Service Worker æ³¨å†Œ...")
    time.sleep(5)
    
    # 4. å†æ¬¡æ£€æŸ¥ workers
    print("\n--- æ£€æŸ¥æ–°çš„ Workers ---")
    if worker_targets:
        print(f"    å‘ç°äº† {len(worker_targets)} ä¸ªæ–° Worker")
    
    # 5. æ¸…ç†
    if 'result' in test_tab:
        target.send_command("Target.closeTarget", {
            "targetId": test_tab['result']['targetId']
        })
    
    time.sleep(2)
    target.close()


# ========================================
# ç¤ºä¾‹ 6: æµè§ˆå™¨ä¸Šä¸‹æ–‡éš”ç¦»ï¼ˆéšèº«æ¨¡å¼æ¨¡æ‹Ÿï¼‰
# ========================================
def example_browser_contexts():
    """
    æ¼”ç¤ºæµè§ˆå™¨ä¸Šä¸‹æ–‡éš”ç¦»:
    1. åˆ›å»ºå¤šä¸ªéš”ç¦»çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
    2. åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­æ“ä½œ
    3. éªŒè¯ Cookie å’Œå­˜å‚¨éš”ç¦»
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 6: æµè§ˆå™¨ä¸Šä¸‹æ–‡éš”ç¦»")
    print("="*60)
    
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    target.send_command("Target.setDiscoverTargets", {"discover": True})
    
    contexts = []
    
    # 1. åˆ›å»ºç¬¬ä¸€ä¸ªéš”ç¦»ä¸Šä¸‹æ–‡
    print("\n--- åˆ›å»ºä¸Šä¸‹æ–‡ 1 ---")
    ctx1 = target.send_command("Target.createBrowserContext", {
        "disposeOnDetach": True
    })
    if 'result' in ctx1:
        ctx1_id = ctx1['result']['browserContextId']
        contexts.append(ctx1_id)
        print(f"    ä¸Šä¸‹æ–‡ 1 ID: {ctx1_id[:40]}...")
        
        # åœ¨ä¸Šä¸‹æ–‡ 1 ä¸­åˆ›å»ºæ ‡ç­¾é¡µ
        tab1 = target.send_command("Target.createTarget", {
            "url": "https://httpbin.org/cookies/set/context1/value1",
            "browserContextId": ctx1_id
        })
        print(f"    å·²åœ¨ä¸Šä¸‹æ–‡ 1 ä¸­åˆ›å»ºæ ‡ç­¾é¡µ")
    
    time.sleep(2)
    
    # 2. åˆ›å»ºç¬¬äºŒä¸ªéš”ç¦»ä¸Šä¸‹æ–‡
    print("\n--- åˆ›å»ºä¸Šä¸‹æ–‡ 2 ---")
    ctx2 = target.send_command("Target.createBrowserContext", {
        "disposeOnDetach": True
    })
    if 'result' in ctx2:
        ctx2_id = ctx2['result']['browserContextId']
        contexts.append(ctx2_id)
        print(f"    ä¸Šä¸‹æ–‡ 2 ID: {ctx2_id[:40]}...")
        
        # åœ¨ä¸Šä¸‹æ–‡ 2 ä¸­åˆ›å»ºæ ‡ç­¾é¡µ
        tab2 = target.send_command("Target.createTarget", {
            "url": "https://httpbin.org/cookies/set/context2/value2",
            "browserContextId": ctx2_id
        })
        print(f"    å·²åœ¨ä¸Šä¸‹æ–‡ 2 ä¸­åˆ›å»ºæ ‡ç­¾é¡µ")
    
    time.sleep(2)
    
    # 3. åˆ›å»ºé»˜è®¤ä¸Šä¸‹æ–‡ä¸­çš„æ ‡ç­¾é¡µ
    print("\n--- åœ¨é»˜è®¤ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºæ ‡ç­¾é¡µ ---")
    tab3 = target.send_command("Target.createTarget", {
        "url": "https://httpbin.org/cookies/set/default/value3"
    })
    
    time.sleep(2)
    
    # 4. è·å–æµè§ˆå™¨ä¸Šä¸‹æ–‡åˆ—è¡¨
    print("\n--- è·å–æ‰€æœ‰æµè§ˆå™¨ä¸Šä¸‹æ–‡ ---")
    all_contexts = target.send_command("Target.getBrowserContexts")
    if 'result' in all_contexts:
        context_ids = all_contexts['result']['browserContextIds']
        print(f"    æµè§ˆå™¨ä¸Šä¸‹æ–‡æ•°é‡: {len(context_ids) + 1}")  # +1 æ˜¯é»˜è®¤ä¸Šä¸‹æ–‡
        for i, ctx_id in enumerate(context_ids, 1):
            print(f"    {i}. {ctx_id[:40]}...")
    
    # 5. æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾é¡µåŠå…¶æ‰€å±ä¸Šä¸‹æ–‡
    print("\n--- æ‰€æœ‰æ ‡ç­¾é¡µåŠå…¶ä¸Šä¸‹æ–‡ ---")
    all_targets = target.send_command("Target.getTargets")
    if 'result' in all_targets:
        pages = [t for t in all_targets['result']['targetInfos'] if t.get('type') == 'page']
        for i, page in enumerate(pages, 1):
            ctx_id = page.get('browserContextId', 'é»˜è®¤ä¸Šä¸‹æ–‡')
            print(f"    {i}. URL: {page.get('url', 'N/A')[:60]}")
            print(f"       ä¸Šä¸‹æ–‡: {ctx_id[:40] if ctx_id != 'é»˜è®¤ä¸Šä¸‹æ–‡' else ctx_id}...")
    
    # 6. æ¸…ç†ä¸Šä¸‹æ–‡ï¼ˆä¼šè‡ªåŠ¨å…³é—­å…¶ä¸­çš„æ ‡ç­¾é¡µï¼‰
    print("\n--- æ¸…ç†: é”€æ¯æ‰€æœ‰åˆ›å»ºçš„ä¸Šä¸‹æ–‡ ---")
    for i, ctx_id in enumerate(contexts, 1):
        target.send_command("Target.disposeBrowserContext", {
            "browserContextId": ctx_id
        })
        print(f"    å·²é”€æ¯ä¸Šä¸‹æ–‡ {i}")
    
    # æ¸…ç†é»˜è®¤ä¸Šä¸‹æ–‡ä¸­çš„æ ‡ç­¾é¡µ
    if 'result' in tab3:
        target.send_command("Target.closeTarget", {
            "targetId": tab3['result']['targetId']
        })
    
    time.sleep(2)
    target.close()


# ========================================
# ç¤ºä¾‹ 7: ç»¼åˆåº”ç”¨ - Target ç®¡ç†å™¨
# ========================================
def example_target_manager():
    """
    ç»¼åˆç¤ºä¾‹: å®ç°å®Œæ•´çš„ Target ç®¡ç†å™¨
    1. å®æ—¶ç›‘æ§æ‰€æœ‰ targets
    2. è‡ªåŠ¨ç®¡ç†è¿æ¥
    3. ç»Ÿè®¡å’ŒæŠ¥å‘Š
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 7: Target ç®¡ç†å™¨")
    print("="*60)
    
    browser_ws = get_browser_websocket_url()
    target = CDPTarget(browser_ws)
    
    # ç®¡ç†å™¨çŠ¶æ€
    manager_state = {
        "all_targets": {},
        "sessions": {},
        "statistics": {
            "created": 0,
            "destroyed": 0,
            "attached": 0,
            "detached": 0
        }
    }
    
    def handle_target_created(event):
        info = event['params']['targetInfo']
        target_id = info['targetId']
        
        manager_state["all_targets"][target_id] = info
        manager_state["statistics"]["created"] += 1
        
        print(f"\nğŸ†• Target #{manager_state['statistics']['created']} åˆ›å»º")
        print(f"    ID: {target_id[:30]}...")
        print(f"    ç±»å‹: {info.get('type', 'N/A')}")
        print(f"    URL: {info.get('url', 'N/A')[:60]}")
    
    def handle_target_destroyed(event):
        target_id = event['params']['targetId']
        
        if target_id in manager_state["all_targets"]:
            del manager_state["all_targets"][target_id]
        
        manager_state["statistics"]["destroyed"] += 1
        print(f"\nâŒ Target é”€æ¯: {target_id[:30]}...")
    
    def handle_target_info_changed(event):
        info = event['params']['targetInfo']
        target_id = info['targetId']
        
        if target_id in manager_state["all_targets"]:
            old_url = manager_state["all_targets"][target_id].get('url', '')
            new_url = info.get('url', '')
            
            if old_url != new_url:
                print(f"\nğŸ”„ Target å¯¼èˆª")
                print(f"    ä»: {old_url[:50]}")
                print(f"    åˆ°: {new_url[:50]}")
            
            manager_state["all_targets"][target_id] = info
    
    def handle_attached_to_target(event):
        session_id = event['params']['sessionId']
        target_id = event['params']['targetInfo']['targetId']
        
        manager_state["sessions"][target_id] = session_id
        manager_state["statistics"]["attached"] += 1
        
        print(f"\nâœ… é™„åŠ åˆ° Target")
        print(f"    Target: {target_id[:30]}...")
        print(f"    Session: {session_id[:30]}...")
    
    def handle_detached_from_target(event):
        session_id = event['params']['sessionId']
        manager_state["statistics"]["detached"] += 1
        
        # æ‰¾åˆ°å¯¹åº”çš„ target_id å¹¶ç§»é™¤
        for tid, sid in list(manager_state["sessions"].items()):
            if sid == session_id:
                del manager_state["sessions"][tid]
                break
        
        print(f"\nâŒ ä» Target åˆ†ç¦»: {session_id[:30]}...")
    
    # æ³¨å†Œæ‰€æœ‰äº‹ä»¶
    target.on_event("Target.targetCreated", handle_target_created)
    target.on_event("Target.targetDestroyed", handle_target_destroyed)
    target.on_event("Target.targetInfoChanged", handle_target_info_changed)
    target.on_event("Target.attachedToTarget", handle_attached_to_target)
    target.on_event("Target.detachedFromTarget", handle_detached_from_target)
    
    # å¯åŠ¨ç®¡ç†å™¨
    print("\n--- å¯åŠ¨ Target ç®¡ç†å™¨ ---")
    target.send_command("Target.setDiscoverTargets", {"discover": True})
    target.send_command("Target.setAutoAttach", {
        "autoAttach": True,
        "waitForDebuggerOnStart": False,
        "flatten": True
    })
    
    time.sleep(2)
    
    # åˆ›å»ºä¸€äº›æµ‹è¯• targets
    print("\n--- åˆ›å»ºæµ‹è¯• Targets ---")
    test_urls = [
        "https://example.com",
        "https://www.wikipedia.org"
    ]
    
    test_targets = []
    for url in test_urls:
        result = target.send_command("Target.createTarget", {"url": url})
        if 'result' in result:
            test_targets.append(result['result']['targetId'])
    
    time.sleep(5)
    
    # æ˜¾ç¤ºå½“å‰çŠ¶æ€
    print("\n" + "="*60)
    print("ğŸ“Š å½“å‰ç®¡ç†å™¨çŠ¶æ€:")
    print(f"    æ´»è·ƒ Targets: {len(manager_state['all_targets'])}")
    print(f"    å·²é™„åŠ ä¼šè¯: {len(manager_state['sessions'])}")
    
    print("\nğŸ“ˆ ç»Ÿè®¡æ•°æ®:")
    for key, value in manager_state['statistics'].items():
        print(f"    {key}: {value}")
    
    print("\nğŸ“‹ Targets è¯¦æƒ…:")
    for i, (tid, info) in enumerate(manager_state['all_targets'].items(), 1):
        print(f"\n  {i}. {info.get('type', 'N/A')}")
        print(f"     ID: {tid[:40]}...")
        print(f"     URL: {info.get('url', 'N/A')[:60]}")
        print(f"     å·²é™„åŠ : {'æ˜¯' if tid in manager_state['sessions'] else 'å¦'}")
    
    # é€šè¿‡ session æ§åˆ¶ target
    print("\n--- é€šè¿‡ Session æ§åˆ¶ Targets ---")
    for tid, session_id in manager_state['sessions'].items():
        if tid in test_targets[:1]:  # åªæ§åˆ¶ç¬¬ä¸€ä¸ªæµ‹è¯• target
            print(f"\næ§åˆ¶ Target: {tid[:30]}...")
            
            # æ‰§è¡Œæˆªå›¾
            message = {
                "id": 999,
                "method": "Page.captureScreenshot",
                "params": {"format": "png"}
            }
            
            target.send_command("Target.sendMessageToTarget", {
                "sessionId": session_id,
                "message": json.dumps(message)
            })
            print(f"    å·²å‘é€æˆªå›¾å‘½ä»¤")
    
    time.sleep(2)
    
    # æ¸…ç†
    print("\n--- æ¸…ç†æ‰€æœ‰æµ‹è¯• Targets ---")
    for tid in test_targets:
        target.send_command("Target.closeTarget", {"targetId": tid})
    
    time.sleep(2)
    
    # æœ€ç»ˆæŠ¥å‘Š
    print("\n" + "="*60)
    print("ğŸ“Š æœ€ç»ˆç»Ÿè®¡:")
    print(f"    æ€»åˆ›å»º: {manager_state['statistics']['created']}")
    print(f"    æ€»é”€æ¯: {manager_state['statistics']['destroyed']}")
    print(f"    æ€»é™„åŠ : {manager_state['statistics']['attached']}")
    print(f"    æ€»åˆ†ç¦»: {manager_state['statistics']['detached']}")
    print(f"    å‰©ä½™æ´»è·ƒ: {len(manager_state['all_targets'])}")
    print("="*60)
    
    target.close()


# ========================================
# ä¸»å‡½æ•°
# ========================================
if __name__ == "__main__":
    print("\n" + "="*60)
    print("CDP Target åŸŸå®Œæ•´ç¤ºä¾‹é›†")
    print("="*60)
    print("\nè¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨:")
    print("chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug")
    print("\né€‰æ‹©è¦è¿è¡Œçš„ç¤ºä¾‹:")
    print("1. Target å‘ç°å’Œä¿¡æ¯è·å–")
    print("2. åˆ›å»ºå’Œç®¡ç† Targets")
    print("3. é™„åŠ åˆ° Target å¹¶æ§åˆ¶")
    print("4. å¤šæ ‡ç­¾é¡µå¹¶è¡Œæ“ä½œ")
    print("5. Service Worker å’Œåå° Targets")
    print("6. æµè§ˆå™¨ä¸Šä¸‹æ–‡éš”ç¦»")
    print("7. Target ç®¡ç†å™¨ï¼ˆç»¼åˆï¼‰")
    print("0. è¿è¡Œæ‰€æœ‰ç¤ºä¾‹")
    
    try:
        choice = input("\nè¯·è¾“å…¥é€‰æ‹© (0-7): ").strip()
        
        examples = {
            "1": example_target_discovery,
            "2": example_create_and_manage_targets,
            "3": example_attach_and_control,
            "4": example_parallel_tabs,
            "5": example_service_workers,
            "6": example_browser_contexts,
            "7": example_target_manager
        }
        
        if choice == "0":
            for name, example in examples.items():
                print(f"\n{'='*60}")
                print(f"è¿è¡Œç¤ºä¾‹ {name}...")
                print(f"{'='*60}")
                example()
                time.sleep(3)
        elif choice in examples:
            examples[choice]()
        else:
            print("æ— æ•ˆé€‰æ‹©")
        
        print("\nâœ… ç¤ºä¾‹æ‰§è¡Œå®Œæˆï¼")
        
    except requests.exceptions.ConnectionError:
        print("\nâŒ é”™è¯¯: æ— æ³•è¿æ¥åˆ° Chrome")
        print("è¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ --remote-debugging-port=9222 å¯åŠ¨")
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
```
