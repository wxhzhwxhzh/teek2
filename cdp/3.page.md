---
id: intro3
permalink: /cdp/p3
title: 'Page æ•™ç¨‹'
---


# Page æ•™ç¨‹
```python
import json
import websocket
import requests
import time
import threading
import base64
from datetime import datetime

def get_websocket_url(port=9222):
    """è·å– WebSocket è°ƒè¯• URL"""
    response = requests.get(f'http://localhost:{port}/json')
    tabs = response.json()
    return tabs[0]['webSocketDebuggerUrl']

class CDPPage:
    """CDP Page å°è£…ç±»"""
    
    def __init__(self, ws_url):
        self.ws = websocket.create_connection(ws_url)
        self.command_id = 0
        self.event_handlers = {}
        self.running = True
        self.events_log = []
        
        # å¯åŠ¨äº‹ä»¶ç›‘å¬çº¿ç¨‹
        self.event_thread = threading.Thread(target=self._event_listener, daemon=True)
        self.event_thread.start()
        
    def send_command(self, method, params=None):
        """å‘é€ CDP å‘½ä»¤"""
        self.command_id += 1
        command = {
            "id": self.command_id,
            "method": method,
            "params": params or {}
        }
        print(f"\n>>> å‘é€å‘½ä»¤: {method}")
        if params:
            print(f"    å‚æ•°: {json.dumps(params, indent=6, ensure_ascii=False)}")
        
        self.ws.send(json.dumps(command))
        
        # ç­‰å¾…å“åº”
        while True:
            response = json.loads(self.ws.recv())
            if 'id' in response and response['id'] == self.command_id:
                if 'error' not in response:
                    print(f"<<< å“åº”æˆåŠŸ")
                    if 'result' in response and response['result']:
                        print(f"    ç»“æœ: {json.dumps(response['result'], indent=6, ensure_ascii=False)[:200]}")
                else:
                    print(f"<<< é”™è¯¯: {response['error']}")
                return response
            elif 'method' in response:
                self._handle_event(response)
    
    def _event_listener(self):
        """åå°ç›‘å¬äº‹ä»¶"""
        while self.running:
            try:
                self.ws.settimeout(0.1)
                message = self.ws.recv()
                data = json.loads(message)
                if 'method' in data:
                    self._handle_event(data)
            except:
                continue
    
    def _handle_event(self, event):
        """å¤„ç†äº‹ä»¶"""
        method = event['method']
        self.events_log.append({
            'timestamp': datetime.now().isoformat(),
            'method': method,
            'params': event.get('params', {})
        })
        
        if method in self.event_handlers:
            self.event_handlers[method](event)
    
    def on_event(self, event_name, handler):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""
        self.event_handlers[event_name] = handler
    
    def wait_for_event(self, event_name, timeout=10):
        """ç­‰å¾…ç‰¹å®šäº‹ä»¶"""
        start_time = time.time()
        while time.time() - start_time < timeout:
            for event in reversed(self.events_log):
                if event['method'] == event_name:
                    return event
            time.sleep(0.1)
        return None
    
    def close(self):
        self.running = False
        time.sleep(0.2)
        self.ws.close()


# ========================================
# ç¤ºä¾‹ 1: åŸºç¡€é¡µé¢ç”Ÿå‘½å‘¨æœŸç›‘å¬
# ========================================
def example_page_lifecycle():
    """
    æ¼”ç¤ºé¡µé¢ç”Ÿå‘½å‘¨æœŸäº‹ä»¶:
    1. Page.enable - å¯ç”¨é¡µé¢äº‹ä»¶
    2. Page.lifecycleEvent - ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
    3. Page.loadEventFired - é¡µé¢åŠ è½½å®Œæˆ
    4. Page.domContentEventFired - DOM å†…å®¹åŠ è½½å®Œæˆ
    5. Page.frameStartedLoading - æ¡†æ¶å¼€å§‹åŠ è½½
    6. Page.frameStoppedLoading - æ¡†æ¶åœæ­¢åŠ è½½
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 1: é¡µé¢ç”Ÿå‘½å‘¨æœŸç›‘å¬")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    
    lifecycle_events = []
    
    def handle_lifecycle(event):
        params = event['params']
        lifecycle_events.append({
            'name': params.get('name'),
            'timestamp': params.get('timestamp'),
            'frameId': params.get('frameId', '')[:20]
        })
        print(f"\nğŸ”„ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶: {params.get('name')}")
        print(f"    æ—¶é—´æˆ³: {params.get('timestamp')}")
    
    def handle_load_event(event):
        print(f"\nâœ… Page.loadEventFired - é¡µé¢å®Œå…¨åŠ è½½")
        print(f"    æ—¶é—´æˆ³: {event['params'].get('timestamp')}")
    
    def handle_dom_content(event):
        print(f"\nâœ… Page.domContentEventFired - DOM å†…å®¹åŠ è½½å®Œæˆ")
        print(f"    æ—¶é—´æˆ³: {event['params'].get('timestamp')}")
    
    def handle_frame_started(event):
        frame_id = event['params'].get('frameId', '')[:20]
        print(f"\nğŸ”µ æ¡†æ¶å¼€å§‹åŠ è½½: {frame_id}...")
    
    def handle_frame_stopped(event):
        frame_id = event['params'].get('frameId', '')[:20]
        print(f"\nğŸ”µ æ¡†æ¶åœæ­¢åŠ è½½: {frame_id}...")
    
    # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    page.on_event("Page.lifecycleEvent", handle_lifecycle)
    page.on_event("Page.loadEventFired", handle_load_event)
    page.on_event("Page.domContentEventFired", handle_dom_content)
    page.on_event("Page.frameStartedLoading", handle_frame_started)
    page.on_event("Page.frameStoppedLoading", handle_frame_stopped)
    
    # 1. å¯ç”¨é¡µé¢äº‹ä»¶
    page.send_command("Page.enable")
    
    # 2. è®¾ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ç›‘å¬
    page.send_command("Page.setLifecycleEventsEnabled", {
        "enabled": True
    })
    
    # 3. å¯¼èˆªåˆ°é¡µé¢
    page.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    
    # ç­‰å¾…é¡µé¢åŠ è½½
    time.sleep(5)
    
    # æ˜¾ç¤ºç”Ÿå‘½å‘¨æœŸæ‘˜è¦
    print("\n" + "="*60)
    print("ğŸ“Š ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ‘˜è¦:")
    for i, event in enumerate(lifecycle_events, 1):
        print(f"    {i}. {event['name']}")
    print("="*60)
    
    page.close()


# ========================================
# ç¤ºä¾‹ 2: é¡µé¢å¯¼èˆªæ§åˆ¶
# ========================================
def example_page_navigation():
    """
    æ¼”ç¤ºé¡µé¢å¯¼èˆªå‘½ä»¤:
    1. Page.navigate - å¯¼èˆªåˆ° URL
    2. Page.reload - é‡è½½é¡µé¢
    3. Page.stopLoading - åœæ­¢åŠ è½½
    4. Page.navigateToHistoryEntry - å¯¼èˆªåˆ°å†å²è®°å½•
    5. Page.getNavigationHistory - è·å–å¯¼èˆªå†å²
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 2: é¡µé¢å¯¼èˆªæ§åˆ¶")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    
    def handle_navigation(event):
        params = event['params']
        print(f"\nğŸ”„ é¡µé¢å¯¼èˆª")
        print(f"    URL: {params.get('url', 'N/A')}")
        print(f"    Frame ID: {params.get('frameId', 'N/A')[:20]}...")
    
    page.on_event("Page.frameNavigated", handle_navigation)
    page.send_command("Page.enable")
    
    # 1. å¯¼èˆªåˆ°ç¬¬ä¸€ä¸ªé¡µé¢
    print("\n--- å¯¼èˆªåˆ° Example.com ---")
    page.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    time.sleep(2)
    
    # 2. å¯¼èˆªåˆ°ç¬¬äºŒä¸ªé¡µé¢
    print("\n--- å¯¼èˆªåˆ° Wikipedia ---")
    page.send_command("Page.navigate", {
        "url": "https://www.wikipedia.org"
    })
    time.sleep(2)
    
    # 3. è·å–å¯¼èˆªå†å²
    print("\n--- è·å–å¯¼èˆªå†å² ---")
    history = page.send_command("Page.getNavigationHistory")
    if 'result' in history:
        entries = history['result'].get('entries', [])
        current_index = history['result'].get('currentIndex', 0)
        print(f"    å½“å‰ç´¢å¼•: {current_index}")
        print(f"    å†å²è®°å½•æ•°: {len(entries)}")
        for i, entry in enumerate(entries):
            marker = " <- å½“å‰" if i == current_index else ""
            print(f"    {i}. {entry.get('url', 'N/A')[:60]}{marker}")
    
    # 4. è¿”å›ä¸Šä¸€é¡µ
    if 'result' in history and history['result'].get('currentIndex', 0) > 0:
        print("\n--- è¿”å›ä¸Šä¸€é¡µ ---")
        prev_index = history['result']['currentIndex'] - 1
        prev_entry_id = history['result']['entries'][prev_index]['id']
        page.send_command("Page.navigateToHistoryEntry", {
            "entryId": prev_entry_id
        })
        time.sleep(2)
    
    # 5. é‡è½½é¡µé¢
    print("\n--- é‡è½½é¡µé¢ ---")
    page.send_command("Page.reload", {
        "ignoreCache": True  # å¿½ç•¥ç¼“å­˜
    })
    time.sleep(2)
    
    page.close()


# ========================================
# ç¤ºä¾‹ 3: æˆªå›¾å’Œ PDF ç”Ÿæˆ
# ========================================
def example_capture_screenshot():
    """
    æ¼”ç¤ºé¡µé¢æ•è·å‘½ä»¤:
    1. Page.captureScreenshot - æˆªå›¾
    2. Page.printToPDF - ç”Ÿæˆ PDF
    3. Page.captureSnapshot - æ•è· MHTML
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 3: æˆªå›¾å’Œ PDF ç”Ÿæˆ")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    page.send_command("Page.enable")
    
    # å¯¼èˆªåˆ°é¡µé¢
    page.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    page.wait_for_event("Page.loadEventFired", timeout=10)
    time.sleep(1)
    
    # 1. å…¨å±æˆªå›¾
    print("\n--- æ•è·å…¨å±æˆªå›¾ ---")
    screenshot = page.send_command("Page.captureScreenshot", {
        "format": "png",
        "quality": 90,
        "captureBeyondViewport": True  # æ•è·æ•´ä¸ªé¡µé¢
    })
    
    if 'result' in screenshot and 'data' in screenshot['result']:
        screenshot_data = base64.b64decode(screenshot['result']['data'])
        filename = f"screenshot_{int(time.time())}.png"
        with open(filename, 'wb') as f:
            f.write(screenshot_data)
        print(f"    âœ… æˆªå›¾å·²ä¿å­˜: {filename}")
        print(f"    å¤§å°: {len(screenshot_data)} å­—èŠ‚")
    
    # 2. æŒ‡å®šåŒºåŸŸæˆªå›¾
    print("\n--- æ•è·æŒ‡å®šåŒºåŸŸæˆªå›¾ ---")
    screenshot = page.send_command("Page.captureScreenshot", {
        "format": "jpeg",
        "quality": 80,
        "clip": {
            "x": 0,
            "y": 0,
            "width": 800,
            "height": 600,
            "scale": 1
        }
    })
    
    if 'result' in screenshot and 'data' in screenshot['result']:
        screenshot_data = base64.b64decode(screenshot['result']['data'])
        filename = f"screenshot_clip_{int(time.time())}.jpg"
        with open(filename, 'wb') as f:
            f.write(screenshot_data)
        print(f"    âœ… åŒºåŸŸæˆªå›¾å·²ä¿å­˜: {filename}")
    
    # 3. ç”Ÿæˆ PDF
    print("\n--- ç”Ÿæˆ PDF ---")
    pdf = page.send_command("Page.printToPDF", {
        "landscape": False,
        "displayHeaderFooter": True,
        "printBackground": True,
        "scale": 1.0,
        "paperWidth": 8.5,
        "paperHeight": 11,
        "marginTop": 0.4,
        "marginBottom": 0.4,
        "marginLeft": 0.4,
        "marginRight": 0.4
    })
    
    if 'result' in pdf and 'data' in pdf['result']:
        pdf_data = base64.b64decode(pdf['result']['data'])
        filename = f"page_{int(time.time())}.pdf"
        with open(filename, 'wb') as f:
            f.write(pdf_data)
        print(f"    âœ… PDF å·²ä¿å­˜: {filename}")
        print(f"    å¤§å°: {len(pdf_data)} å­—èŠ‚")
    
    page.close()


# ========================================
# ç¤ºä¾‹ 4: é¡µé¢èµ„æºç®¡ç†
# ========================================
def example_page_resources():
    """
    æ¼”ç¤ºé¡µé¢èµ„æºç®¡ç†:
    1. Page.getResourceTree - è·å–èµ„æºæ ‘
    2. Page.getResourceContent - è·å–èµ„æºå†…å®¹
    3. Page.frameAttached - æ¡†æ¶é™„åŠ äº‹ä»¶
    4. Page.frameDetached - æ¡†æ¶åˆ†ç¦»äº‹ä»¶
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 4: é¡µé¢èµ„æºç®¡ç†")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    
    def handle_frame_attached(event):
        frame_id = event['params'].get('frameId', '')[:20]
        parent_id = event['params'].get('parentFrameId', '')[:20]
        print(f"\nğŸ”— æ¡†æ¶é™„åŠ : {frame_id}... (çˆ¶: {parent_id}...)")
    
    def handle_frame_detached(event):
        frame_id = event['params'].get('frameId', '')[:20]
        print(f"\nâŒ æ¡†æ¶åˆ†ç¦»: {frame_id}...")
    
    page.on_event("Page.frameAttached", handle_frame_attached)
    page.on_event("Page.frameDetached", handle_frame_detached)
    page.send_command("Page.enable")
    
    # å¯¼èˆªåˆ°æœ‰å¤šä¸ªèµ„æºçš„é¡µé¢
    page.send_command("Page.navigate", {
        "url": "https://news.ycombinator.com"
    })
    page.wait_for_event("Page.loadEventFired", timeout=10)
    time.sleep(2)
    
    # 1. è·å–èµ„æºæ ‘
    print("\n--- è·å–èµ„æºæ ‘ ---")
    resource_tree = page.send_command("Page.getResourceTree")
    
    if 'result' in resource_tree and 'frameTree' in resource_tree['result']:
        frame_tree = resource_tree['result']['frameTree']
        frame = frame_tree.get('frame', {})
        resources = frame_tree.get('resources', [])
        
        print(f"\nä¸»æ¡†æ¶:")
        print(f"    ID: {frame.get('id', 'N/A')[:30]}...")
        print(f"    URL: {frame.get('url', 'N/A')}")
        print(f"    MIME ç±»å‹: {frame.get('mimeType', 'N/A')}")
        
        print(f"\nèµ„æºåˆ—è¡¨ (å…± {len(resources)} ä¸ª):")
        for i, resource in enumerate(resources[:10], 1):  # åªæ˜¾ç¤ºå‰10ä¸ª
            print(f"    {i}. {resource.get('type', 'N/A'):15} - {resource.get('url', 'N/A')[:80]}")
        
        if len(resources) > 10:
            print(f"    ... è¿˜æœ‰ {len(resources) - 10} ä¸ªèµ„æº")
        
        # 2. è·å–ç¬¬ä¸€ä¸ªèµ„æºçš„å†…å®¹
        if resources:
            first_resource = resources[0]
            print(f"\n--- è·å–èµ„æºå†…å®¹ ---")
            print(f"    èµ„æº URL: {first_resource.get('url', 'N/A')[:80]}")
            
            content = page.send_command("Page.getResourceContent", {
                "frameId": frame.get('id'),
                "url": first_resource.get('url')
            })
            
            if 'result' in content:
                content_data = content['result'].get('content', '')
                is_base64 = content['result'].get('base64Encoded', False)
                print(f"    Base64 ç¼–ç : {is_base64}")
                print(f"    å†…å®¹å¤§å°: {len(content_data)} å­—ç¬¦")
                if not is_base64:
                    print(f"    å†…å®¹é¢„è§ˆ: {content_data[:200]}...")
    
    page.close()


# ========================================
# ç¤ºä¾‹ 5: JavaScript å¯¹è¯æ¡†å¤„ç†
# ========================================
def example_javascript_dialogs():
    """
    æ¼”ç¤º JavaScript å¯¹è¯æ¡†å¤„ç†:
    1. Page.javascriptDialogOpening - å¯¹è¯æ¡†æ‰“å¼€äº‹ä»¶
    2. Page.handleJavaScriptDialog - å¤„ç†å¯¹è¯æ¡†
    3. alert, confirm, prompt æ‹¦æˆª
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 5: JavaScript å¯¹è¯æ¡†å¤„ç†")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    
    dialog_count = [0]
    
    def handle_dialog_opening(event):
        dialog_count[0] += 1
        params = event['params']
        dialog_type = params.get('type', 'N/A')
        message = params.get('message', 'N/A')
        default_prompt = params.get('defaultPrompt', '')
        
        print(f"\nğŸ’¬ å¯¹è¯æ¡† #{dialog_count[0]} æ‰“å¼€:")
        print(f"    ç±»å‹: {dialog_type}")
        print(f"    æ¶ˆæ¯: {message}")
        if default_prompt:
            print(f"    é»˜è®¤å€¼: {default_prompt}")
        
        # è‡ªåŠ¨å¤„ç†å¯¹è¯æ¡†
        if dialog_type == "alert":
            print(f"    â†’ è‡ªåŠ¨æ¥å— alert")
            page.send_command("Page.handleJavaScriptDialog", {
                "accept": True
            })
        elif dialog_type == "confirm":
            print(f"    â†’ è‡ªåŠ¨ç¡®è®¤ confirm")
            page.send_command("Page.handleJavaScriptDialog", {
                "accept": True
            })
        elif dialog_type == "prompt":
            print(f"    â†’ è‡ªåŠ¨è¾“å…¥ prompt: 'è‡ªåŠ¨å›å¤'")
            page.send_command("Page.handleJavaScriptDialog", {
                "accept": True,
                "promptText": "è‡ªåŠ¨å›å¤"
            })
    
    page.on_event("Page.javascriptDialogOpening", handle_dialog_opening)
    page.send_command("Page.enable")
    page.send_command("Runtime.enable")
    
    # å¯¼èˆªåˆ°é¡µé¢
    page.send_command("Page.navigate", {
        "url": "https://example.com"
    })
    page.wait_for_event("Page.loadEventFired", timeout=10)
    
    # 1. è§¦å‘ alert
    print("\n--- è§¦å‘ alert ---")
    page.send_command("Runtime.evaluate", {
        "expression": "alert('è¿™æ˜¯ä¸€ä¸ª alert å¯¹è¯æ¡†')"
    })
    time.sleep(1)
    
    # 2. è§¦å‘ confirm
    print("\n--- è§¦å‘ confirm ---")
    result = page.send_command("Runtime.evaluate", {
        "expression": "confirm('ç¡®è®¤æ“ä½œå—ï¼Ÿ')",
        "awaitPromise": True
    })
    time.sleep(1)
    
    # 3. è§¦å‘ prompt
    print("\n--- è§¦å‘ prompt ---")
    result = page.send_command("Runtime.evaluate", {
        "expression": "prompt('è¯·è¾“å…¥æ‚¨çš„åå­—:', 'é»˜è®¤åç§°')",
        "awaitPromise": True
    })
    time.sleep(1)
    
    print(f"\nğŸ“Š æ€»å…±å¤„ç†äº† {dialog_count[0]} ä¸ªå¯¹è¯æ¡†")
    
    page.close()


# ========================================
# ç¤ºä¾‹ 6: é¡µé¢è§†å£å’Œè®¾å¤‡æ¨¡æ‹Ÿ
# ========================================
def example_viewport_and_emulation():
    """
    æ¼”ç¤ºè§†å£å’Œè®¾å¤‡æ¨¡æ‹Ÿ:
    1. Page.setDeviceMetricsOverride - è®¾ç½®è®¾å¤‡æŒ‡æ ‡
    2. Emulation.setTouchEmulationEnabled - å¯ç”¨è§¦æ‘¸æ¨¡æ‹Ÿ
    3. Emulation.setGeolocationOverride - è®¾ç½®åœ°ç†ä½ç½®
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 6: è§†å£å’Œè®¾å¤‡æ¨¡æ‹Ÿ")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    page.send_command("Page.enable")
    
    # 1. è®¾ç½®ç§»åŠ¨è®¾å¤‡è§†å£ (iPhone 12)
    print("\n--- æ¨¡æ‹Ÿ iPhone 12 ---")
    page.send_command("Emulation.setDeviceMetricsOverride", {
        "width": 390,
        "height": 844,
        "deviceScaleFactor": 3,
        "mobile": True,
        "screenOrientation": {
            "type": "portraitPrimary",
            "angle": 0
        }
    })
    
    # 2. è®¾ç½® User-Agent
    page.send_command("Emulation.setUserAgentOverride", {
        "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15"
    })
    
    # 3. å¯ç”¨è§¦æ‘¸æ¨¡æ‹Ÿ
    page.send_command("Emulation.setTouchEmulationEnabled", {
        "enabled": True,
        "maxTouchPoints": 5
    })
    
    # 4. è®¾ç½®åœ°ç†ä½ç½®
    print("\n--- è®¾ç½®åœ°ç†ä½ç½® (çº½çº¦) ---")
    page.send_command("Emulation.setGeolocationOverride", {
        "latitude": 40.7128,
        "longitude": -74.0060,
        "accuracy": 100
    })
    
    # å¯¼èˆªåˆ°é¡µé¢
    page.send_command("Page.navigate", {
        "url": "https://www.whatismybrowser.com"
    })
    page.wait_for_event("Page.loadEventFired", timeout=10)
    time.sleep(2)
    
    # æˆªå›¾çœ‹æ•ˆæœ
    screenshot = page.send_command("Page.captureScreenshot", {
        "format": "png"
    })
    
    if 'result' in screenshot and 'data' in screenshot['result']:
        screenshot_data = base64.b64decode(screenshot['result']['data'])
        filename = f"mobile_screenshot_{int(time.time())}.png"
        with open(filename, 'wb') as f:
            f.write(screenshot_data)
        print(f"\nâœ… ç§»åŠ¨ç«¯æˆªå›¾å·²ä¿å­˜: {filename}")
    
    # 5. æ¢å¤æ­£å¸¸è§†å£
    print("\n--- æ¢å¤æ¡Œé¢è§†å£ ---")
    page.send_command("Emulation.clearDeviceMetricsOverride")
    
    page.close()


# ========================================
# ç¤ºä¾‹ 7: ç»¼åˆåº”ç”¨ - é¡µé¢ç›‘æ§å™¨
# ========================================
def example_page_monitor():
    """
    ç»¼åˆç¤ºä¾‹: å®ç°å®Œæ•´çš„é¡µé¢ç›‘æ§
    1. ç›‘æ§æ‰€æœ‰é¡µé¢äº‹ä»¶
    2. æ€§èƒ½æŒ‡æ ‡æ”¶é›†
    3. èµ„æºåŠ è½½ç»Ÿè®¡
    4. é”™è¯¯æ•è·
    """
    print("\n" + "="*60)
    print("ç¤ºä¾‹ 7: é¡µé¢ç›‘æ§å™¨")
    print("="*60)
    
    page = CDPPage(get_websocket_url())
    
    # ç»Ÿè®¡æ•°æ®
    stats = {
        "navigation_count": 0,
        "load_time": None,
        "dom_content_time": None,
        "resources_loaded": 0,
        "javascript_errors": 0,
        "console_messages": 0,
        "dialogs_opened": 0
    }
    
    start_time = time.time()
    
    # äº‹ä»¶å¤„ç†å™¨
    def handle_frame_navigated(event):
        stats["navigation_count"] += 1
        url = event['params'].get('frame', {}).get('url', 'N/A')
        print(f"\nğŸ“ é¡µé¢å¯¼èˆª #{stats['navigation_count']}: {url[:80]}")
    
    def handle_load_event(event):
        stats["load_time"] = time.time() - start_time
        print(f"\nâœ… é¡µé¢åŠ è½½å®Œæˆ: {stats['load_time']:.2f}ç§’")
    
    def handle_dom_content(event):
        stats["dom_content_time"] = time.time() - start_time
        print(f"\nâœ… DOM å†…å®¹åŠ è½½: {stats['dom_content_time']:.2f}ç§’")
    
    def handle_console_message(event):
        stats["console_messages"] += 1
        params = event['params']
        level = params.get('level', 'log')
        text = params.get('text', '')
        print(f"\nğŸ’¬ æ§åˆ¶å° [{level}]: {text[:100]}")
    
    def handle_exception(event):
        stats["javascript_errors"] += 1
        params = event['params']
        description = params.get('exceptionDetails', {}).get('text', 'N/A')
        print(f"\nâŒ JavaScript é”™è¯¯ #{stats['javascript_errors']}: {description[:100]}")
    
    def handle_dialog(event):
        stats["dialogs_opened"] += 1
        dialog_type = event['params'].get('type', 'N/A')
        print(f"\nğŸ’¬ å¯¹è¯æ¡† #{stats['dialogs_opened']}: {dialog_type}")
        page.send_command("Page.handleJavaScriptDialog", {"accept": True})
    
    # æ³¨å†Œæ‰€æœ‰äº‹ä»¶
    page.on_event("Page.frameNavigated", handle_frame_navigated)
    page.on_event("Page.loadEventFired", handle_load_event)
    page.on_event("Page.domContentEventFired", handle_dom_content)
    page.on_event("Runtime.consoleAPICalled", handle_console_message)
    page.on_event("Runtime.exceptionThrown", handle_exception)
    page.on_event("Page.javascriptDialogOpening", handle_dialog)
    
    # å¯ç”¨æ‰€æœ‰å¿…è¦çš„åŸŸ
    page.send_command("Page.enable")
    page.send_command("Runtime.enable")
    page.send_command("Network.enable")
    
    # å¯ç”¨æ§åˆ¶å°æ¶ˆæ¯
    page.send_command("Runtime.consoleAPICalled")
    
    # å¯¼èˆªåˆ°é¡µé¢
    print("\n--- å¼€å§‹ç›‘æ§ ---")
    page.send_command("Page.navigate", {
        "url": "https://news.ycombinator.com"
    })
    
    # ç›‘æ§10ç§’
    time.sleep(10)
    
    # è·å–æ€§èƒ½æŒ‡æ ‡
    print("\n--- è·å–æ€§èƒ½æŒ‡æ ‡ ---")
    metrics = page.send_command("Performance.getMetrics")
    
    if 'result' in metrics and 'metrics' in metrics['result']:
        print("\nğŸ“Š æ€§èƒ½æŒ‡æ ‡:")
        for metric in metrics['result']['metrics'][:10]:
            print(f"    {metric['name']}: {metric['value']}")
    
    # æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
    print("\n" + "="*60)
    print("ğŸ“Š ç›‘æ§æ‘˜è¦:")
    print(f"    å¯¼èˆªæ¬¡æ•°: {stats['navigation_count']}")
    print(f"    DOM åŠ è½½æ—¶é—´: {stats['dom_content_time']:.2f}ç§’" if stats['dom_content_time'] else "    DOM åŠ è½½æ—¶é—´: N/A")
    print(f"    å®Œå…¨åŠ è½½æ—¶é—´: {stats['load_time']:.2f}ç§’" if stats['load_time'] else "    å®Œå…¨åŠ è½½æ—¶é—´: N/A")
    print(f"    æ§åˆ¶å°æ¶ˆæ¯: {stats['console_messages']}")
    print(f"    JavaScript é”™è¯¯: {stats['javascript_errors']}")
    print(f"    å¯¹è¯æ¡†: {stats['dialogs_opened']}")
    print("="*60)
    
    page.close()


# ========================================
# ä¸»å‡½æ•°
# ========================================
if __name__ == "__main__":
    print("\n" + "="*60)
    print("CDP Page.enable å®Œæ•´ç¤ºä¾‹é›†")
    print("="*60)
    print("\nè¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨:")
    print("chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug")
    print("\né€‰æ‹©è¦è¿è¡Œçš„ç¤ºä¾‹:")
    print("1. é¡µé¢ç”Ÿå‘½å‘¨æœŸç›‘å¬")
    print("2. é¡µé¢å¯¼èˆªæ§åˆ¶")
    print("3. æˆªå›¾å’Œ PDF ç”Ÿæˆ")
    print("4. é¡µé¢èµ„æºç®¡ç†")
    print("5. JavaScript å¯¹è¯æ¡†å¤„ç†")
    print("6. è§†å£å’Œè®¾å¤‡æ¨¡æ‹Ÿ")
    print("7. é¡µé¢ç›‘æ§å™¨ï¼ˆç»¼åˆï¼‰")
    print("0. è¿è¡Œæ‰€æœ‰ç¤ºä¾‹")
    
    try:
        choice = input("\nè¯·è¾“å…¥é€‰æ‹© (0-7): ").strip()
        
        examples = {
            "1": example_page_lifecycle,
            "2": example_page_navigation,
            "3": example_capture_screenshot,
            "4": example_page_resources,
            "5": example_javascript_dialogs,
            "6": example_viewport_and_emulation,
            "7": example_page_monitor
        }
        
        if choice == "0":
            for name, example in examples.items():
                print(f"\n{'='*60}")
                print(f"è¿è¡Œç¤ºä¾‹ {name}...")
                print(f"{'='*60}")
                example()
                time.sleep(2)
        elif choice in examples:
            examples[choice]()
        else:
            print("æ— æ•ˆé€‰æ‹©")
        
        print("\nâœ… ç¤ºä¾‹æ‰§è¡Œå®Œæˆï¼")
        
    except requests.exceptions.ConnectionError:
        print("\nâŒ é”™è¯¯: æ— æ³•è¿æ¥åˆ° Chrome")
        print("è¯·ç¡®ä¿ Chrome å·²ä½¿ç”¨ --remote-debugging-port=9222 å¯åŠ¨")
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
    
# %%
```
